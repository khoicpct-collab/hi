// ========== CÔNG CỤ XÓA PHẦN THỪA VẬT LIỆU (CỤC TẨY THỦ CÔNG) ==========
let isErasingTexture = false;
let currentTextureObject = null;
let eraseHistory = [];

function activateTextureEraseMode() {
    const activeObj = canvas.getActiveObject();
    if (!activeObj || activeObj.name !== 'texture') {
        updateStatus('Vui lòng chọn một vật liệu (texture) để xóa phần thừa');
        return;
    }
    
    currentToolMode = 'textureErase';
    currentTextureObject = activeObj;
    isErasingTexture = true;
    eraseHistory = [];
    
    // Lưu trạng thái ban đầu của texture
    const originalState = {
        left: currentTextureObject.left,
        top: currentTextureObject.top,
        scaleX: currentTextureObject.scaleX,
        scaleY: currentTextureObject.scaleY,
        angle: currentTextureObject.angle,
        opacity: currentTextureObject.opacity
    };
    eraseHistory.push(originalState);
    
    // Tạm thời vô hiệu hóa selection
    canvas.selection = false;
    
    // Hiển thị bảng điều khiển cục tẩy
    document.getElementById('drawingControls').style.display = 'flex';
    document.getElementById('drawingControls').innerHTML = `
        <div style="color: #4ecdc4; font-weight: bold; margin-bottom: 10px;">
            <i class="fas fa-cut"></i> XÓA PHẦN THỪA VẬT LIỆU
        </div>
        <div class="drawing-control">
            <label>Kích thước:</label>
            <input type="range" id="eraseBrushSize" min="5" max="100" value="30">
            <span id="eraseBrushSizeValue" style="color: white; min-width: 30px;">30px</span>
        </div>
        <div class="drawing-control">
            <label>Độ cứng:</label>
            <input type="range" id="eraseBrushHardness" min="0" max="100" value="50">
            <span id="eraseBrushHardnessValue" style="color: white; min-width: 30px;">50%</span>
        </div>
        <div style="color: #ffcc00; font-size: 0.9em; margin: 10px 0;">
            <i class="fas fa-info-circle"></i> Giữ và kéo chuột để xóa phần thừa
        </div>
        <button class="history-btn" id="applyTextureErase" style="margin-top: 10px; background: #27ae60;">
            <i class="fas fa-check"></i> Áp dụng
        </button>
        <button class="history-btn" id="undoTextureErase" style="margin-top: 5px;">
            <i class="fas fa-undo"></i> Hoàn tác nét
        </button>
        <button class="history-btn" id="cancelTextureErase" style="margin-top: 5px;">
            <i class="fas fa-times"></i> Hủy
        </button>
    `;
    
    // Tạo một canvas ẩn để xử lý xóa
    const eraseCanvas = document.createElement('canvas');
    const eraseCtx = eraseCanvas.getContext('2d');
    
    // Đặt kích thước canvas xóa bằng với texture
    const textureBounds = currentTextureObject.getBoundingRect();
    const textureWidth = textureBounds.width;
    const textureHeight = textureBounds.height;
    
    eraseCanvas.width = textureWidth;
    eraseCanvas.height = textureHeight;
    
    // Tô màu trắng cho canvas (trắng = giữ lại, đen = xóa)
    eraseCtx.fillStyle = 'white';
    eraseCtx.fillRect(0, 0, textureWidth, textureHeight);
    
    // Thêm canvas vào DOM ẩn để sử dụng
    eraseCanvas.style.display = 'none';
    document.body.appendChild(eraseCanvas);
    currentTextureObject._eraseCanvas = eraseCanvas;
    currentTextureObject._eraseCtx = eraseCtx;
    
    // Sự kiện điều chỉnh brush
    document.getElementById('eraseBrushSize').addEventListener('input', function(e) {
        document.getElementById('eraseBrushSizeValue').textContent = e.target.value + 'px';
    });
    
    document.getElementById('eraseBrushHardness').addEventListener('input', function(e) {
        document.getElementById('eraseBrushHardnessValue').textContent = e.target.value + '%';
    });
    
    // Sự kiện nút
    document.getElementById('applyTextureErase').addEventListener('click', applyTextureErase);
    document.getElementById('undoTextureErase').addEventListener('click', undoLastErase);
    document.getElementById('cancelTextureErase').addEventListener('click', cancelTextureErase);
    
    // Thiết lập sự kiện chuột cho xóa
    setupEraseEvents();
    
    updateToolButtons();
    updateStatus('Công cụ xóa phần thừa: Giữ và kéo chuột để xóa');
}

function setupEraseEvents() {
    let isDrawing = false;
    let lastX = 0;
    let lastY = 0;
    
    canvas.off('mouse:down');
    canvas.off('mouse:move');
    canvas.off('mouse:up');
    
    canvas.on('mouse:down', function(event) {
        if (!isErasingTexture || !currentTextureObject) return;
        
        const pointer = canvas.getPointer(event.e);
        
        // Kiểm tra xem click có nằm trong texture không
        const target = canvas.findTarget(event.e);
        if (target !== currentTextureObject) {
            updateStatus('Vui lòng xóa trên vùng vật liệu');
            return;
        }
        
        isDrawing = true;
        
        // Chuyển đổi tọa độ canvas sang tọa độ texture
        const textureBounds = currentTextureObject.getBoundingRect();
        const x = ((pointer.x - textureBounds.left) / textureBounds.width) * currentTextureObject._eraseCanvas.width;
        const y = ((pointer.y - textureBounds.top) / textureBounds.height) * currentTextureObject._eraseCanvas.height;
        
        lastX = x;
        lastY = y;
        
        // Vẽ điểm đầu tiên
        drawErasePoint(x, y);
        previewErase(x, y);
    });
    
    canvas.on('mouse:move', function(event) {
        if (!isErasingTexture || !currentTextureObject || !isDrawing) return;
        
        const pointer = canvas.getPointer(event.e);
        
        // Chuyển đổi tọa độ canvas sang tọa độ texture
        const textureBounds = currentTextureObject.getBoundingRect();
        const x = ((pointer.x - textureBounds.left) / textureBounds.width) * currentTextureObject._eraseCanvas.width;
        const y = ((pointer.y - textureBounds.top) / textureBounds.height) * currentTextureObject._eraseCanvas.height;
        
        // Vẽ đường từ điểm cuối cùng đến điểm hiện tại
        drawEraseLine(lastX, lastY, x, y);
        previewErase(x, y);
        
        lastX = x;
        lastY = y;
    });
    
    canvas.on('mouse:up', function() {
        if (!isErasingTexture || !currentTextureObject) return;
        
        if (isDrawing) {
            // Lưu trạng thái sau khi xóa
            saveEraseState();
            updateStatus('Đã xóa vùng được chọn');
        }
        
        isDrawing = false;
    });
}

function drawErasePoint(x, y) {
    const ctx = currentTextureObject._eraseCtx;
    const brushSize = parseInt(document.getElementById('eraseBrushSize').value);
    const hardness = parseInt(document.getElementById('eraseBrushHardness').value) / 100;
    
    // Tạo gradient cho brush
    const gradient = ctx.createRadialGradient(x, y, 0, x, y, brushSize);
    gradient.addColorStop(0, `rgba(0, 0, 0, ${hardness})`);
    gradient.addColorStop(1, 'rgba(0, 0, 0, 0)');
    
    ctx.fillStyle = gradient;
    ctx.fillRect(x - brushSize, y - brushSize, brushSize * 2, brushSize * 2);
}

function drawEraseLine(x1, y1, x2, y2) {
    const ctx = currentTextureObject._eraseCtx;
    const brushSize = parseInt(document.getElementById('eraseBrushSize').value);
    const hardness = parseInt(document.getElementById('eraseBrushHardness').value) / 100;
    
    // Tính khoảng cách giữa hai điểm
    const distance = Math.sqrt(Math.pow(x2 - x1, 2) + Math.pow(y2 - y1, 2));
    
    // Vẽ nhiều điểm dọc theo đường thẳng
    const steps = Math.ceil(distance / (brushSize * 0.5));
    
    for (let i = 0; i <= steps; i++) {
        const t = i / steps;
        const x = x1 + (x2 - x1) * t;
        const y = y1 + (y2 - y1) * t;
        
        // Tạo gradient cho brush
        const gradient = ctx.createRadialGradient(x, y, 0, x, y, brushSize);
        gradient.addColorStop(0, `rgba(0, 0, 0, ${hardness})`);
        gradient.addColorStop(1, 'rgba(0, 0, 0, 0)');
        
        ctx.fillStyle = gradient;
        ctx.fillRect(x - brushSize, y - brushSize, brushSize * 2, brushSize * 2);
    }
}

function previewErase(x, y) {
    // Tạo preview cục tẩy
    const previewCircle = canvas.getObjects().find(obj => obj.name === 'erase_preview');
    
    if (previewCircle) {
        canvas.remove(previewCircle);
    }
    
    const brushSize = parseInt(document.getElementById('eraseBrushSize').value);
    const textureBounds = currentTextureObject.getBoundingRect();
    const canvasX = (x / currentTextureObject._eraseCanvas.width) * textureBounds.width + textureBounds.left;
    const canvasY = (y / currentTextureObject._eraseCanvas.height) * textureBounds.height + textureBounds.top;
    
    const circle = new fabric.Circle({
        left: canvasX - brushSize / 2,
        top: canvasY - brushSize / 2,
        radius: brushSize / 2,
        fill: 'rgba(255, 0, 0, 0.3)',
        stroke: '#ff0000',
        strokeWidth: 2,
        selectable: false,
        evented: false,
        name: 'erase_preview'
    });
    
    canvas.add(circle);
    canvas.renderAll();
}

function saveEraseState() {
    // Lưu trạng thái hiện tại của canvas xóa
    const canvasData = currentTextureObject._eraseCanvas.toDataURL();
    eraseHistory.push(canvasData);
}

function undoLastErase() {
    if (eraseHistory.length > 1) {
        eraseHistory.pop(); // Xóa trạng thái hiện tại
        const previousState = eraseHistory[eraseHistory.length - 1];
        
        if (typeof previousState === 'string') {
            // Nếu là canvas data
            const img = new Image();
            img.onload = () => {
                currentTextureObject._eraseCtx.clearRect(0, 0, 
                    currentTextureObject._eraseCanvas.width, 
                    currentTextureObject._eraseCanvas.height);
                currentTextureObject._eraseCtx.drawImage(img, 0, 0);
                updateStatus('Đã hoàn tác nét xóa cuối cùng');
            };
            img.src = previousState;
        } else {
            // Nếu là trạng thái ban đầu
            currentTextureObject._eraseCtx.fillStyle = 'white';
            currentTextureObject._eraseCtx.fillRect(0, 0, 
                currentTextureObject._eraseCanvas.width, 
                currentTextureObject._eraseCanvas.height);
            updateStatus('Đã hoàn tác về trạng thái ban đầu');
        }
    }
}

function applyTextureErase() {
    if (!isErasingTexture || !currentTextureObject) return;
    
    // Áp dụng mask lên texture
    const eraseCanvas = currentTextureObject._eraseCanvas;
    
    fabric.Image.fromURL(eraseCanvas.toDataURL(), function(maskImg) {
        // Tạo một canvas tạm thời để kết hợp texture và mask
        const tempCanvas = document.createElement('canvas');
        const tempCtx = tempCanvas.getContext('2d');
        
        tempCanvas.width = currentTextureObject.width;
        tempCanvas.height = currentTextureObject.height;
        
        // Vẽ texture gốc
        const img = new Image();
        img.onload = function() {
            tempCtx.drawImage(img, 0, 0, tempCanvas.width, tempCanvas.height);
            
            // Áp dụng mask
            tempCtx.globalCompositeOperation = 'destination-in';
            tempCtx.drawImage(eraseCanvas, 0, 0, tempCanvas.width, tempCanvas.height);
            
            // Tạo ảnh mới từ canvas
            fabric.Image.fromURL(tempCanvas.toDataURL(), function(newImg) {
                newImg.set({
                    left: currentTextureObject.left,
                    top: currentTextureObject.top,
                    scaleX: currentTextureObject.scaleX,
                    scaleY: currentTextureObject.scaleY,
                    angle: currentTextureObject.angle,
                    opacity: currentTextureObject.opacity,
                    globalCompositeOperation: currentTextureObject.globalCompositeOperation,
                    hasControls: true,
                    hasBorders: true,
                    cornerStyle: 'circle',
                    cornerColor: '#4ecdc4',
                    borderColor: '#4ecdc4',
                    cornerSize: 12,
                    transparentCorners: false,
                    name: 'texture'
                });
                
                canvas.remove(currentTextureObject);
                canvas.add(newImg);
                canvas.setActiveObject(newImg);
                canvas.renderAll();
                
                // Dọn dẹp
                cleanupEraseMode();
                
                saveToHistory();
                updateStatus('Đã áp dụng xóa phần thừa thành công!');
            });
        };
        
        img.src = currentTextureObject.toDataURL();
        
    });
}

function cancelTextureErase() {
    if (!isErasingTexture || !currentTextureObject) return;
    
    // Dọn dẹp
    cleanupEraseMode();
    
    updateStatus('Đã hủy thao tác xóa phần thừa');
}

function cleanupEraseMode() {
    // Xóa preview
    const previewCircle = canvas.getObjects().find(obj => obj.name === 'erase_preview');
    if (previewCircle) {
        canvas.remove(previewCircle);
    }
    
    // Xóa canvas xóa nếu tồn tại
    if (currentTextureObject && currentTextureObject._eraseCanvas) {
        currentTextureObject._eraseCanvas.remove();
        delete currentTextureObject._eraseCanvas;
        delete currentTextureObject._eraseCtx;
    }
    
    // Bật lại selection
    canvas.selection = true;
    
    // Xóa sự kiện
    canvas.off('mouse:down');
    canvas.off('mouse:move');
    canvas.off('mouse:up');
    
    // Reset trạng thái
    isErasingTexture = false;
    currentTextureObject = null;
    eraseHistory = [];
    currentToolMode = 'select';
    
    canvas.renderAll();
    
    document.getElementById('drawingControls').style.display = 'none';
    restoreDrawingControls();
    updateToolButtons();
}

// ========== NÚT "XÓA CLIPPING" (phục hồi vật liệu) ==========
document.getElementById('removeClippingBtn').addEventListener('click', function() {
    const activeObj = canvas.getActiveObject();
    if (activeObj && activeObj.clipPath) {
        activeObj.set({
            clipPath: null,
            dirty: true
        });
        canvas.renderAll();
        saveToHistory();
        updateStatus('Đã xóa clipping, vật liệu đã được phục hồi');
    } else {
        updateStatus('Vật liệu không có clipping để xóa');
    }
});

// ========== CHUYỂN ĐỔI CÔNG CỤ ==========
function setToolMode(mode) {
    if (currentToolMode === 'draw') {
        deactivateDrawingMode();
    } else if (currentToolMode === 'erase') {
        deactivateDrawingMode();
    } else if (currentToolMode === 'textureErase') {
        // Hủy chế độ xóa nếu đang active
        cancelTextureErase();
    }
    
    currentToolMode = mode;
    
    document.querySelectorAll('.tools .tool-btn').forEach(btn => {
        btn.classList.remove('active-tool');
    });

    if (mode === 'hand') {
        document.getElementById('handToolBtn').classList.add('active-tool');
        canvas.selection = false;
        canvas.defaultCursor = 'grab';
        canvas.hoverCursor = 'grab';
        updateStatus('Chế độ Bàn Tay (Pan) được kích hoạt');
    } else if (mode === 'draw') {
        document.getElementById('drawBtn').classList.add('active-tool');
        activateDrawingMode();
    } else if (mode === 'erase') {
        document.getElementById('eraseBtn').classList.add('active-tool');
        activateErasingMode();
    } else if (mode === 'textureErase') {
        document.getElementById('eraseBtn').classList.add('active-tool');
        activateTextureEraseMode();
    } else {
        document.getElementById('transformBtn').classList.add('active-tool');
        canvas.selection = true;
        canvas.defaultCursor = 'default';
        canvas.hoverCursor = 'move';
        updateStatus('Chế độ Select/Transform được kích hoạt');
    }
    canvas.renderAll();
}

// ========== SỰ KIỆN NÚT XÓA ==========
document.getElementById('eraseBtn').addEventListener('click', function() {
    if (currentToolMode === 'textureErase' || currentToolMode === 'erase') {
        setToolMode('select');
    } else {
        // Kiểm tra nếu có vật liệu được chọn
        const activeObj = canvas.getActiveObject();
        if (activeObj && activeObj.name === 'texture') {
            setToolMode('textureErase');
        } else {
            setToolMode('erase');
        }
    }
});
