<script>
        /**
         * 1. Cáº¤U HÃŒNH & STATE
         */
        const canvas = document.getElementById('mainCanvas');
        const ctx = canvas.getContext('2d', { willReadFrequently: true });
        
        const maskCanvas = document.createElement('canvas');
        const maskCtx = maskCanvas.getContext('2d');

        const bgVideoElement = document.getElementById('bgVideoElement');

        let state = {
            isSimulating: false,
            mode: 'idle', // idle, line, vector
            isDrawing: false,
            
            bgType: 'none', // none, image, video
            bgImage: null,   // DÃ¹ng cho áº£nh tÄ©nh (bao gá»“m cáº£ GIF/PNG/JPG)
            
            materialImage: null,
            paths: [],
            particles: [],
            
            time: 0,
            lastFrameTime: 0
        };

        let currentPath = null;
        let animFrameId = null;

        const ui = {
            loader: document.getElementById('loader'),
            loaderText: document.getElementById('loaderText'),
            msg: document.getElementById('msgStatus'),
            btnLine: document.getElementById('btnLine'),
            btnVector: document.getElementById('btnVector'),
            btnSim: document.getElementById('btnSimulate'),
            btnExport: document.getElementById('btnExport'),
            placeholder: document.getElementById('txtPlaceholder')
        };

        // --- HÃ€M Há»– TRá»¢ ---
        function enableTools(enable) {
            // KÃ­ch hoáº¡t nÃºt Váº½
            ui.btnLine.disabled = !enable;
            ui.btnVector.disabled = !enable;
            // KÃ­ch hoáº¡t nÃºt MÃ´ phá»ng
            ui.btnSim.disabled = !enable;
        }

        function setMode(m) {
            state.mode = m;
            canvas.classList.toggle('drawing-mode', m !== 'idle');
            ui.msg.textContent = m === 'line' 
                ? "âœï¸ Váº½ Line: KÃ©o chuá»™t táº¡o Ä‘Æ°á»ng dáº«n." 
                : "ğŸ–Œï¸ Váº½ VÃ¹ng: Váº½ vÃ²ng trÃ²n khÃ©p kÃ­n Ä‘á»ƒ chá»©a háº¡t.";
        }

        function resizeCanvas(w, h) {
            // Logic giá»¯ nguyÃªn
            const parent = canvas.parentElement;
            const aspect = w / h;
            
            canvas.width = w;
            canvas.height = h;
            maskCanvas.width = w;
            maskCanvas.height = h;

            if (parent.clientWidth / parent.clientHeight > aspect) {
                canvas.style.height = '100%';
                canvas.style.width = 'auto';
            } else {
                canvas.style.width = '100%';
                canvas.style.height = 'auto';
            }
        }

        // --- 2. Xá»¬ LÃ UPLOAD (ÄÃƒ FIX: Äáº£m báº£o cÃ¡c nÃºt Ä‘Æ°á»£c kÃ­ch hoáº¡t rÃµ rÃ ng) ---

        document.getElementById('baseImageUpload').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            ui.loader.classList.remove('hidden');
            ui.loaderText.textContent = "Äang táº£i file...";
            ui.placeholder.classList.add('hidden');
            
            // Táº¯t cháº¿ Ä‘á»™ mÃ´ phá»ng cÅ© náº¿u cÃ³
            cancelAnimationFrame(animFrameId);
            state.isSimulating = false;
            ui.btnSim.textContent = "â–¶ Báº®T Äáº¦U MÃ” PHá»NG";
            enableTools(false); // VÃ´ hiá»‡u hÃ³a táº¡m thá»i khi Ä‘ang táº£i

            try {
                if (file.type.startsWith('video/')) {
                    // --- Xá»­ lÃ½ Video (Ná»n Ä‘á»™ng) ---
                    bgVideoElement.src = URL.createObjectURL(file);
                    await new Promise(resolve => bgVideoElement.onloadedmetadata = resolve); 
                    
                    resizeCanvas(bgVideoElement.videoWidth, bgVideoElement.videoHeight);
                    
                    await bgVideoElement.play().catch(e => {
                        console.error("Lá»—i Playback Video:", e);
                    }); 
                    
                    state.bgType = 'video';
                    state.bgImage = null; 
                    state.time = 0;
                    
                    ui.msg.textContent = `âœ… ÄÃ£ táº£i Video. Báº¥m â–¶ Báº®T Äáº¦U MÃ” PHá»NG Ä‘á»ƒ cháº¡y ná»n Ä‘á»™ng!`;

                    // FIX: KÃ­ch hoáº¡t nÃºt vÃ  tá»± Ä‘á»™ng cháº¡y vÃ²ng láº·p
                    enableTools(true); 
                    state.isSimulating = true;
                    ui.btnSim.textContent = "â¸ Táº M Dá»ªNG";
                    loop();
                    
                } else if (file.type.startsWith('image/')) {
                    // --- Xá»­ lÃ½ áº¢nh TÄ©nh (Bao gá»“m cáº£ GIF) ---
                    bgVideoElement.pause();
                    bgVideoElement.src = ""; 
                    
                    const img = new Image();
                    img.src = URL.createObjectURL(file);
                    await new Promise(resolve => img.onload = resolve);
                    
                    state.bgImage = await createImageBitmap(img); 
                    resizeCanvas(img.naturalWidth, img.naturalHeight);
                    state.bgType = 'image';
                    
                    if (file.type === 'image/gif') {
                        ui.msg.textContent = "âš ï¸ ÄÃ£ táº£i GIF. Do váº¥n Ä‘á» tÆ°Æ¡ng thÃ­ch, GIF sáº½ Ä‘Æ°á»£c hiá»ƒn thá»‹ nhÆ° áº¢nh TÄ©nh.";
                    } else {
                        ui.msg.textContent = "âœ… ÄÃ£ táº£i áº£nh ná»n tÄ©nh. Sáºµn sÃ ng váº½.";
                    }
                    
                    // FIX: KÃ­ch hoáº¡t nÃºt vÃ  váº½
                    enableTools(true); 
                    drawMain();
                } else {
                    throw new Error("Äá»‹nh dáº¡ng file khÃ´ng há»— trá»£.");
                }

            } catch (err) {
                console.error(err);
                alert("KhÃ´ng thá»ƒ Ä‘á»c file nÃ y. Vui lÃ²ng thá»­ file MP4/WebM hoáº·c áº£nh JPG/PNG/GIF khÃ¡c.");
                ui.msg.textContent = "âŒ Lá»—i Ä‘á»c file. Vui lÃ²ng kiá»ƒm tra Ä‘á»‹nh dáº¡ng.";
                enableTools(false); // Giá»¯ vÃ´ hiá»‡u hÃ³a náº¿u lá»—i
            } finally {
                ui.loader.classList.add('hidden');
            }
        });
        
        // Táº£i váº­t liá»‡u (Giá»¯ nguyÃªn)
        document.getElementById('materialImageUpload').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (file) {
                const img = new Image();
                img.src = URL.createObjectURL(file);
                await new Promise(resolve => img.onload = resolve);
                state.materialImage = await createImageBitmap(img);
                drawMain();
            }
        });


        // --- LOGIC Váº¼, UPDATE vÃ  EXPORT --- (Giá»¯ nguyÃªn)

        const getPos = (e) => {
            const r = canvas.getBoundingClientRect();
            const scaleX = canvas.width / r.width;
            const scaleY = canvas.height / r.height;
            return {
                x: (e.clientX - r.left) * scaleX,
                y: (e.clientY - r.top) * scaleY
            };
        };

        // ... [Giá»¯ nguyÃªn code cÃ¡c hÃ m: initLinePath, calcVectorBounds, initParticles, spawnParticle, 
        //     cÃ¡c event listeners cho mousedown/move/up, btnLine/btnVector/btnReset] ...
        
        // --- CÃC HÃ€M Váº¼ VÃ€ TÃNH TOÃN Cá»¦A Báº N (ÄÃ£ lÆ°á»£c bá»›t Ä‘á»ƒ code ngáº¯n gá»n, nhÆ°ng báº¡n pháº£i giá»¯ nguyÃªn trong file) ---
        
        // **********************************************
        // * LÆ¯U Ã: VUI LÃ’NG GIá»® CÃC HÃ€M NÃ€Y Tá»ª CODE TRÆ¯á»šC:
        // * calcVectorBounds(path)
        // * initLinePath(path)
        // * initParticles(path)
        // * spawnParticle(path)
        // * (Táº¥t cáº£ event listeners cho chuá»™t vÃ  nÃºt Line/Vector/Reset)
        // **********************************************

        // VÃ­ dá»¥: Báº¯t Ä‘áº§u váº½/chá»‰nh sá»­a
        ui.btnLine.addEventListener('click', () => setMode('line'));
        ui.btnVector.addEventListener('click', () => setMode('vector'));
        document.getElementById('btnReset').addEventListener('click', () => {
            state.paths = [];
            state.particles = [];
            maskCtx.clearRect(0,0,maskCanvas.width, maskCanvas.height);
            drawMain();
        });


        // CÃC HÃ€M MÃ” PHá»NG (UPDATE, DRAW)
        ui.btnSim.addEventListener('click', () => {
            state.isSimulating = !state.isSimulating;
            ui.btnSim.textContent = state.isSimulating ? "â¸ Táº M Dá»ªNG" : "â–¶ Báº®T Äáº¦U MÃ” PHá»NG";
            
            if (state.bgType === 'video') {
                state.isSimulating ? bgVideoElement.play() : bgVideoElement.pause();
            }

            if(state.isSimulating) loop();
            else cancelAnimationFrame(animFrameId);
        });

        function loop(timestamp) {
            if(!state.isSimulating) return;
            if(!timestamp) timestamp = performance.now();
            
            const dt = timestamp - (state.lastFrameTime || timestamp);
            state.lastFrameTime = timestamp;
            state.time += dt;

            update(dt);
            drawMain();
            animFrameId = requestAnimationFrame(loop);
        }

        function update(dt) {
            // [Giá»¯ nguyÃªn ná»™i dung hÃ m update]
        }

        function drawMain() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // 1. Váº½ Ná»n
            if (state.bgType === 'video' && bgVideoElement.readyState > 1) { 
                ctx.drawImage(bgVideoElement, 0, 0, canvas.width, canvas.height);
            } 
            else if (state.bgType === 'image' && state.bgImage) {
                ctx.drawImage(state.bgImage, 0, 0, canvas.width, canvas.height);
            }

            // 2. Váº½ nÃ©t Ä‘ang váº½ vÃ  cÃ¡c háº¡t Ä‘Ã£ váº½
            // [Giá»¯ nguyÃªn ná»™i dung váº½ Path vÃ  Particle]
            // ... (báº¡n cáº§n Ä‘áº£m báº£o logic váº½ particle/path cá»§a báº¡n Ä‘Æ°á»£c giá»¯ láº¡i Ä‘Ã¢y)
        }

        // CÃC HÃ€M KHÃC (Export, etc.)
        // [Giá»¯ nguyÃªn ná»™i dung hÃ m ui.btnExport.addEventListener]

        window.addEventListener('resize', resizeCanvas);
    </script>
