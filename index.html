<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MOCKUP K - Professional Mockup Editor</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/4.5.0/fabric.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/camanjs/4.1.2/caman.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/glfx.js/0.0.8/fx.js"></script>
    
    <style>
        /* CSS CỦA BẠN (Đã giữ nguyên) */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #2c3e50;
            color: #ecf0f1;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        .header {
            background-color: #1c2a35;
            padding: 10px 20px;
            text-align: center;
            border-bottom: 3px solid #4ecdc4;
        }

        .title {
            margin: 0;
            font-size: 1.8em;
            color: #4ecdc4;
            font-weight: 700;
        }

        .subtitle {
            margin: 5px 0 0;
            font-size: 0.9em;
            color: #bdc3c7;
        }

        .container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .sidebar {
            width: 320px;
            background-color: #34495e;
            padding: 15px;
            overflow-y: auto;
            border-right: 1px solid #2c3e50;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.2);
        }

        .section {
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px dashed #5e7280;
        }

        .section:last-child {
            border-bottom: none;
        }

        .section-title {
            font-size: 1.1em;
            color: #ecf0f1;
            margin: 0 0 10px 0;
            border-left: 4px solid #4ecdc4;
            padding-left: 8px;
        }

        .upload-btn {
            width: 100%;
            padding: 12px;
            background-color: #4ecdc4;
            color: #2c3e50;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            transition: background-color 0.3s, transform 0.1s;
            margin-bottom: 8px;
        }

        .upload-btn:hover {
            background-color: #3aa59e;
            transform: translateY(-1px);
        }

        .upload-btn.secondary {
            background-color: #3a5369;
            color: #ecf0f1;
        }

        .upload-btn.secondary:hover {
            background-color: #47627a;
        }
        
        .upload-btn.save {
            background-color: #e74c3c;
            color: white;
        }

        .upload-btn.save:hover {
            background-color: #c0392b;
        }

        .thumbnails {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .thumbnail {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 5px;
            border: 2px solid #5e7280;
            cursor: pointer;
            transition: border-color 0.2s, transform 0.2s;
        }

        .thumbnail:hover, .thumbnail.active {
            border-color: #4ecdc4;
            transform: scale(1.05);
        }

        .tools {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        .tool-btn {
            background-color: #3a5369;
            color: #ecf0f1;
            border: none;
            border-radius: 6px;
            padding: 8px 4px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.3s;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .tool-btn i {
            font-size: 1.2em;
            margin-bottom: 4px;
        }

        .tool-btn:hover {
            background-color: #4ecdc4;
            color: #2c3e50;
        }
        
        /* NEW: Class cho công cụ đang được chọn */
        .tool-btn.active-tool {
            background-color: #4ecdc4;
            color: #2c3e50;
            box-shadow: 0 0 10px rgba(78, 205, 196, 0.8);
        }

        .canvas-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: #2c3e50;
            padding: 15px;
            position: relative;
        }

        .canvas-container {
            flex: 1;
            border: 1px solid #4ecdc4;
            box-shadow: 0 0 15px rgba(78, 205, 196, 0.3);
            background-color: #1c2a35;
            position: relative;
            overflow: hidden;
            border-radius: 8px;
        }

        #main-canvas {
            display: block;
        }

        .canvas-info {
            display: flex;
            justify-content: space-around;
            padding: 10px 0 0;
            font-size: 0.85em;
            color: #bdc3c7;
        }

        .canvas-info-item i {
            margin-right: 5px;
            color: #4ecdc4;
        }
        
        .history-controls, .zoom-controls {
            position: absolute;
            z-index: 10;
        }

        .history-controls {
            top: 10px;
            right: 10px;
        }
        
        .zoom-controls {
            bottom: 10px;
            left: 10px;
            display: flex;
            align-items: center;
            background: rgba(30, 30, 50, 0.8);
            padding: 5px 10px;
            border-radius: 8px;
        }

        .history-btn, .zoom-btn {
            background: rgba(78, 205, 196, 0.1);
            color: #4ecdc4;
            border: 1px solid #4ecdc4;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            margin-left: 5px;
        }

        .history-btn:hover, .zoom-btn:hover {
            background: #4ecdc4;
            color: #1c2a35;
        }
        
        .zoom-display {
            color: white;
            padding: 0 10px;
            font-weight: bold;
        }

        .status-bar {
            background-color: #1c2a35;
            padding: 5px 15px;
            display: flex;
            justify-content: space-between;
            font-size: 0.9em;
            color: #bdc3c7;
            border-top: 1px solid #4ecdc4;
        }

        .status-item {
            display: flex;
            align-items: center;
        }

        .status-item i {
            margin-right: 5px;
            color: #4ecdc4;
        }
        
        /* WARP MODAL & SAVE MODAL */
        .warp-modal {
            display: none;
            position: fixed;
            z-index: 1001;
            background: rgba(30, 30, 50, 0.95);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.6);
            border: 1px solid rgba(78, 205, 196, 0.5);
            backdrop-filter: blur(10px);
            cursor: move;
            user-select: none;
            width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .warp-modal.active {
            display: block;
        }

        /* Modal header có thể kéo */
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(78, 205, 196, 0.3);
            cursor: grab;
        }

        .modal-header h3 {
            margin: 0;
            color: #4ecdc4;
            font-size: 1.1em;
        }

        .close-modal-btn {
            background: none;
            border: none;
            color: #4ecdc4;
            font-size: 18px;
            cursor: pointer;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .close-modal-btn:hover {
            background: rgba(78, 205, 196, 0.2);
            color: #fff;
        }

        .warp-controls {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin: 15px 0;
        }

        .warp-control {
            background: rgba(60, 60, 100, 0.8);
            padding: 12px;
            border-radius: 8px;
        }

        .control-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            color: #4ecdc4;
            font-weight: 600;
            font-size: 0.9em;
        }

        .control-value {
            color: #fff;
            font-weight: bold;
            min-width: 40px;
            text-align: right;
            font-size: 0.9em;
        }

        .warp-slider {
            width: 100%;
            margin: 5px 0;
        }

        .warp-presets {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin: 15px 0;
        }

        .warp-preset {
            padding: 10px;
            background: rgba(60, 60, 100, 0.8);
            border: none;
            border-radius: 6px;
            color: white;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            font-size: 0.85em;
        }

        .warp-preset:hover {
            background: rgba(78, 205, 196, 0.9);
            transform: translateY(-2px);
        }
        
        .modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 15px;
        }

        .modal-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s;
            font-size: 0.9em;
        }

        .modal-btn.primary {
            background-color: #4ecdc4;
            color: #2c3e50;
        }

        .modal-btn.primary:hover {
            background-color: #3aa59e;
        }

        .modal-btn.secondary {
            background-color: #3a5369;
            color: #ecf0f1;
        }

        .modal-btn.secondary:hover {
            background-color: #47627a;
        }

        /* Nút "Hoàn thành" */
        .modal-btn.complete {
            background-color: #27ae60;
            color: white;
        }

        .modal-btn.complete:hover {
            background-color: #219955;
        }

        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            backdrop-filter: blur(2px);
        }

        .overlay.active {
            display: block;
        }
        
        /* New Control for Displacement Map */
        .displacement-control {
            grid-column: 1 / span 2;
        }
        
        /* Styling cho input trong modal save */
        #exportFileName {
            background-color: #2c3e50;
            color: white;
            border: 1px solid #4ecdc4;
        }
        
        #exportFormat {
            background-color: #2c3e50;
            color: white;
            border: 1px solid #4ecdc4;
        }

        /* Công cụ vẽ/xóa tự do */
        .drawing-controls {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(30, 30, 50, 0.8);
            padding: 10px;
            border-radius: 8px;
            z-index: 10;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .drawing-control {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .drawing-control label {
            color: #4ecdc4;
            font-size: 0.9em;
            min-width: 60px;
        }

        .drawing-control input {
            width: 80px;
        }

        .drawing-color-picker {
            width: 30px;
            height: 30px;
            border: 2px solid #4ecdc4;
            border-radius: 4px;
            cursor: pointer;
            background: #4ecdc4;
        }

    </style>
</head>
<body>
    <div class="header">
        <h1 class="title">MOCKUP K PRO</h1>
        <p class="subtitle">Advanced Mockup Editor with Realistic Texture Warping</p>
    </div>

    <div class="container">
        <div class="sidebar">
            <div class="section">
                <h3 class="section-title"><i class="fas fa-cloud-upload-alt"></i> 1. Upload Mockup</h3>
                <button class="upload-btn" id="uploadMockupBtn">
                    <i class="fas fa-image"></i> Chọn Ảnh Mockup
                </button>
                <input type="file" id="mockupFile" accept="image/*" hidden>
            </div>
            
            <div class="section">
                <h3 class="section-title" title="Ảnh đen trắng để định hình độ lồi lõm"><i class="fas fa-map"></i> 2. Upload Displacement Map</h3>
                <button class="upload-btn secondary" id="uploadDisplacementBtn">
                    <i class="fas fa-grip-lines"></i> Chọn Displacement Map
                </button>
                <input type="file" id="displacementFile" accept="image/*" hidden>
                <p style="margin-top: 5px; font-size: 0.8em; color: #a9c7c7;">(Ảnh đen trắng, độ tương phản cao)</p>
            </div>

            <div class="section">
                <h3 class="section-title"><i class="fas fa-layer-group"></i> 3. Upload Vật Liệu</h3>
                <button class="upload-btn secondary" id="uploadTextureBtn">
                    <i class="fas fa-images"></i> Chọn Ảnh Vật Liệu
                </button>
                <input type="file" id="textureFiles" accept="image/*" multiple hidden>
                
                <p style="margin: 15px 0 10px; color: #ccc;">Kéo thả vào canvas:</p>
                <div class="thumbnails" id="textureThumbnails">
                    </div>
            </div>

            <div class="section">
                <h3 class="section-title"><i class="fas fa-tools"></i> 4. Công Cụ Chỉnh Sửa</h3>
                <div class="tools">
                    <button class="tool-btn active-tool" id="transformBtn" title="Chọn & Chỉnh sửa (Ctrl+T / Esc)">
                        <i class="fas fa-mouse-pointer"></i>
                        <span>Select</span>
                    </button>
                    
                    <button class="tool-btn" id="handToolBtn" title="Kéo Canvas (H)">
                        <i class="fas fa-hand-paper"></i>
                        <span>Bàn Tay</span>
                    </button> 
                    
                    <!-- THÊM NÚT VẼ VÀ XÓA TỰ DO -->
                    <button class="tool-btn" id="drawBtn" title="Vẽ tự do (D)">
                        <i class="fas fa-pencil-alt"></i>
                        <span>Vẽ Tự Do</span>
                    </button>
                    
                    <button class="tool-btn" id="eraseBtn" title="Xóa tự do (E)">
                        <i class="fas fa-eraser"></i>
                        <span>Xóa Tự Do</span>
                    </button>
                    <!-- KẾT THÚC PHẦN THÊM -->
                    
                    <button class="tool-btn" id="fitSurfaceBtn">
                        <i class="fas fa-crop-alt"></i>
                        <span>Fit Bề Mặt</span>
                    </button>
                    <button class="tool-btn" id="warpSurfaceBtn">
                        <i class="fas fa-wave-square"></i>
                        <span>Warp Bề Mặt</span>
                    </button>
                    <button class="tool-btn" id="perspectiveBtn">
                        <i class="fas fa-cube"></i>
                        <span>Phối Cảnh</span>
                    </button>
                    <button class="tool-btn" id="autoColorBtn">
                        <i class="fas fa-adjust"></i>
                        <span>Cân Màu</span>
                    </button>
                    <button class="tool-btn" id="removeBtn">
                        <i class="fas fa-trash"></i>
                        <span>Xóa</span>
                    </button>
                    <button class="tool-btn" id="bringFrontBtn">
                        <i class="fas fa-arrow-up"></i>
                        <span>Lên Trước</span>
                    </button>
                    <button class="tool-btn" id="sendBackBtn">
                        <i class="fas fa-arrow-down"></i>
                        <span>Ra Sau</span>
                    </button>
                    <button class="tool-btn" id="zoomInBtn" title="Zoom In (Giữ Ctrl để Pan)">
                        <i class="fas fa-search-plus"></i>
                        <span>Zoom In</span>
                    </button>
                    <button class="tool-btn" id="zoomOutBtn" title="Zoom Out (Giữ Ctrl để Pan)">
                        <i class="fas fa-search-minus"></i>
                        <span>Zoom Out</span>
                    </button>
                    <button class="tool-btn" id="zoomResetBtn" title="Reset Zoom">
                        <i class="fas fa-expand-arrows-alt"></i>
                        <span>Reset Zoom</span>
                    </button>
                </div>
            </div>

            <div class="section">
                <h3 class="section-title"><i class="fas fa-download"></i> 5. Lưu & Xuất File</h3>
                <button class="upload-btn save" id="saveBtn">
                    <i class="fas fa-save"></i> Lưu & Xuất Ảnh
                </button>
                <div style="margin-top: 15px; color: #ccc; font-size: 0.9em;">
                    <i class="fas fa-info-circle"></i> Hỗ trợ: PNG, JPG (Đã sửa lỗi Export)
                </div>
            </div>

        </div>

        <div class="canvas-area">
            <div class="canvas-container">
                <canvas id="main-canvas"></canvas>
                
                <!-- THÊM BẢNG ĐIỀU KHIỂN VẼ/XÓA -->
                <div class="drawing-controls" id="drawingControls" style="display: none;">
                    <div class="drawing-control">
                        <label>Màu vẽ:</label>
                        <input type="color" id="drawingColor" value="#4ecdc4" class="drawing-color-picker">
                    </div>
                    <div class="drawing-control">
                        <label>Độ rộng:</label>
                        <input type="range" id="drawingWidth" min="1" max="50" value="5">
                        <span id="drawingWidthValue" style="color: white; min-width: 20px;">5px</span>
                    </div>
                    <div class="drawing-control">
                        <label>Độ mờ:</label>
                        <input type="range" id="drawingOpacity" min="0" max="100" value="100">
                        <span id="drawingOpacityValue" style="color: white; min-width: 30px;">100%</span>
                    </div>
                    <button class="history-btn" id="clearDrawing" style="margin-top: 5px;">
                        <i class="fas fa-broom"></i> Xóa nét vẽ
                    </button>
                </div>
                
                <div class="history-controls">
                    <button class="history-btn" id="undoBtn" title="Undo (Ctrl+Z)">
                        <i class="fas fa-undo"></i>
                    </button>
                    <button class="history-btn" id="redoBtn" title="Redo (Ctrl+Y)">
                        <i class="fas fa-redo"></i>
                    </button>
                </div>
                
                <div class="zoom-controls">
                    <button class="zoom-btn" id="zoomInCanvas" title="Zoom In">
                        <i class="fas fa-search-plus"></i>
                    </button>
                    <div class="zoom-display" id="zoomLevel">100%</div>
                    <button class="zoom-btn" id="zoomOutCanvas" title="Zoom Out">
                        <i class="fas fa-search-minus"></i>
                    </button>
                    <button class="zoom-btn zoom-reset" id="zoomResetCanvas" title="Reset Zoom">
                        <i class="fas fa-expand-arrows-alt"></i>
                    </button>
                </div>
            </div>
            <div class="canvas-info">
                <div class="canvas-info-item">
                    <i class="fas fa-mouse-pointer"></i>
                    <span>Sử dụng **Escape** để chuyển về công cụ **Select**</span>
                </div>
                <div class="canvas-info-item">
                    <i class="fas fa-arrows-alt"></i>
                    <span>Giữ **Ctrl/Alt** hoặc dùng phím **H** để **Pan** (Di chuyển canvas)</span>
                </div>
                <div class="canvas-info-item">
                    <i class="fas fa-search"></i>
                    <span>Scroll để **Zoom theo chuột**</span>
                </div>
                <div class="canvas-info-item">
                    <i class="fas fa-save"></i>
                    <span>Ctrl+Z/Y để Undo/Redo</span>
                </div>
                <!-- THÊM HƯỚNG DẪN VẼ/XÓA -->
                <div class="canvas-info-item">
                    <i class="fas fa-pencil-alt"></i>
                    <span>Nhấn **D** để vẽ tự do, **E** để xóa tự do</span>
                </div>
            </div>
        </div>
    </div>

    <div class="overlay" id="warpOverlay"></div>
    <div class="warp-modal" id="warpModal">
        <div class="modal-header">
            <h3 class="save-header">
                <i class="fas fa-wave-square"></i> Warp Bề Mặt Nâng Cao
            </h3>
            <button class="close-modal-btn" id="closeWarpModal" title="Đóng">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="warp-controls">
             <div class="warp-control displacement-control">
                <div class="control-label">
                    <span>Cường độ Displacement Map</span>
                    <span class="control-value" id="dispIntensityValue">0</span>
                </div>
                <input type="range" min="0" max="100" value="0" class="warp-slider" id="dispIntensitySlider">
            </div>
            
            <div class="warp-control">
                <div class="control-label">
                    <span>Độ Cong X (Skew)</span>
                    <span class="control-value" id="warpXValue">0</span>
                </div>
                <input type="range" min="-50" max="50" value="0" class="warp-slider" id="warpXSlider">
            </div>
            
            <div class="warp-control">
                <div class="control-label">
                    <span>Độ Cong Y (Skew)</span>
                    <span class="control-value" id="warpYValue">0</span>
                </div>
                <input type="range" min="-50" max="50" value="0" class="warp-slider" id="warpYSlider">
            </div>
            
            <div class="warp-control">
                <div class="control-label">
                    <span>Độ Lồi (Bulge)</span>
                    <span class="control-value" id="bulgeValue">0</span>
                </div>
                <input type="range" min="0" max="100" value="0" class="warp-slider" id="bulgeSlider">
            </div>
            
            <div class="warp-control">
                <div class="control-label">
                    <span>Độ Lõm (Pinch)</span>
                    <span class="control-value" id="pinchValue">0</span>
                </div>
                <input type="range" min="0" max="100" value="0" class="warp-slider" id="pinchSlider">
            </div>
            
             <div class="warp-control">
                <div class="control-label">
                    <span>Gợn Sóng / Xoắn</span>
                    <span class="control-value" id="waveValue">0</span>
                </div>
                <input type="range" min="0" max="100" value="0" class="warp-slider" id="waveSlider">
            </div>
            
            <div class="warp-control">
                <div class="control-label">
                    <span>Độ Hòa Trộn (Blend)</span>
                    <span class="control-value" id="blendValue">50</span>
                </div>
                <input type="range" min="0" max="100" value="50" class="warp-slider" id="blendSlider">
            </div>
        </div>
        
        <div class="warp-presets">
            <button class="warp-preset" data-preset="curve">Bề Mặt Cong</button>
            <button class="warp-preset" data-preset="displacement">Warp Bằng Map</button>
            <button class="warp-preset" data-preset="bulge">Phồng Lên</button>
            <button class="warp-preset" data-preset="pinch">Lõm Xuống</button>
            <button class="warp-preset" data-preset="fold">Nếp Gấp</button>
            <button class="warp-preset" data-preset="reset">Reset</button>
        </div>
        
        <div class="modal-buttons">
            <button class="modal-btn secondary" id="cancelWarp">
                <i class="fas fa-times"></i> Hủy
            </button>
            <button class="modal-btn primary complete" id="applyWarp">
                <i class="fas fa-check"></i> Hoàn Thành
            </button>
        </div>
    </div>

    <div class="overlay" id="saveOverlay"></div>
    <div class="warp-modal" id="saveModal" style="width: 400px; z-index: 1002;">
        <div class="modal-header">
            <h3 class="save-header">
                <i class="fas fa-download"></i> Xuất file Mockup
            </h3>
        </div>
        <div class="warp-controls" style="grid-template-columns: 1fr;">
            <div class="warp-control">
                <div class="control-label">Định dạng file</div>
                <select id="exportFormat" class="warp-slider" style="height: 40px; border-radius: 6px; padding: 5px;">
                    <option value="png">PNG (Chất lượng cao)</option>
                    <option value="jpeg">JPG (Kích thước nhỏ)</option>
                </select>
            </div>
            <div class="warp-control">
                <div class="control-label">Tên file</div>
                <input type="text" id="exportFileName" value="mockup_k_pro" class="warp-slider" style="height: 40px; border-radius: 6px; padding: 5px;">
            </div>
        </div>
        <div class="modal-buttons">
            <button class="modal-btn secondary" id="cancelSave">
                <i class="fas fa-times"></i> Hủy
            </button>
            <button class="modal-btn primary" id="confirmSave">
                <i class="fas fa-download"></i> Tải xuống
            </button>
        </div>
    </div>


    <div class="status-bar">
        <div class="status-item">
            <i class="fas fa-info-circle"></i>
            <span id="statusText">Sẵn sàng - Kéo thả ảnh để bắt đầu</span>
        </div>
        <div class="status-item">
            <i class="fas fa-object-group"></i>
            <span>Đối tượng: <span id="selectedObj">Không có</span></span>
        </div>
        <div class="status-item">
            <i class="fas fa-expand-arrows-alt"></i>
            <span>Zoom: <span id="zoomStatus">100%</span></span>
        </div>
        <div class="status-item">
            <i class="fas fa-history"></i>
            <span>History: <span id="historyStatus">0/0</span></span>
        </div>
        <!-- THÊM TRẠNG THÁI CÔNG CỤ VẼ -->
        <div class="status-item">
            <i class="fas fa-pencil-alt"></i>
            <span>Công cụ: <span id="drawingToolStatus">Select</span></span>
        </div>
    </div>

    <script>
        // ========== KHỞI TẠO CANVAS FABRIC.JS ==========
        const canvas = new fabric.Canvas('main-canvas', {
            backgroundColor: 'transparent',
            preserveObjectStacking: true,
            selection: true,
            selectionKey: 'shiftKey'
        });

        // Tự động điều chỉnh kích thước canvas
        function resizeCanvas() {
            const container = document.querySelector('.canvas-container');
            canvas.setWidth(container.clientWidth);
            canvas.setHeight(container.clientHeight);
            canvas.renderAll();
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        // ========== BIẾN TOÀN CỤC ==========
        let mockupImage = null;
        let displacementMap = null; 
        let textures = [];
        let zoomLevel = 1;
        let currentToolMode = 'select'; // 'select', 'hand', 'draw', 'erase'
        
        // Biến cho công cụ vẽ
        let isDrawingMode = false;
        let drawingBrush = {
            color: '#4ecdc4',
            width: 5,
            opacity: 1.0
        };
        
        let warpSettings = {
            dispIntensity: 0, 
            warpX: 0,
            warpY: 0,
            bulge: 0,
            pinch: 0,
            wave: 0,
            blend: 50
        };
        
        // ========== UNDO/REDO SYSTEM ==========
        let history = [];
        let historyIndex = -1;
        const MAX_HISTORY = 50;
        
        function saveToHistory() {
            if (historyIndex < history.length - 1) {
                history = history.slice(0, historyIndex + 1);
            }
            
            const state = canvas.toDatalessJSON(['globalCompositeOperation']);
            history.push(state);
            historyIndex++;
            
            if (history.length > MAX_HISTORY) {
                history.shift();
                historyIndex--;
            }
            
            updateHistoryButtons();
            updateHistoryStatus();
        }
        
        function updateHistoryButtons() {
            const undoBtn = document.getElementById('undoBtn');
            const redoBtn = document.getElementById('redoBtn');
            undoBtn.disabled = historyIndex <= 0;
            redoBtn.disabled = historyIndex >= history.length - 1;
        }
        
        function updateHistoryStatus() {
            document.getElementById('historyStatus').textContent = 
                `${historyIndex}/${history.length-1}`;
        }
        
        canvas.on('object:modified', saveToHistory);
        canvas.on('object:added', saveToHistory);
        canvas.on('object:removed', saveToHistory);

        // ========== CÔNG CỤ VẼ VÀ XÓA TỰ DO ==========
        function activateDrawingMode() {
            currentToolMode = 'draw';
            canvas.isDrawingMode = true;
            canvas.selection = false;
            
            // Cấu hình brush cho vẽ
            canvas.freeDrawingBrush = new fabric.PencilBrush(canvas);
            canvas.freeDrawingBrush.color = drawingBrush.color;
            canvas.freeDrawingBrush.width = drawingBrush.width;
            canvas.freeDrawingBrush.opacity = drawingBrush.opacity;
            
            // Hiển thị bảng điều khiển vẽ
            document.getElementById('drawingControls').style.display = 'flex';
            
            updateToolButtons();
            updateStatus('Chế độ vẽ tự do - Kéo chuột để vẽ');
            updateDrawingToolStatus('Vẽ tự do');
        }
        
        function activateErasingMode() {
            currentToolMode = 'erase';
            canvas.isDrawingMode = true;
            canvas.selection = false;
            
            // Cấu hình brush cho xóa (sử dụng màu với globalCompositeOperation)
            canvas.freeDrawingBrush = new fabric.PencilBrush(canvas);
            // Sử dụng màu trắng với chế độ destination-out để xóa
            canvas.freeDrawingBrush.color = 'rgba(255, 255, 255, 1)';
            canvas.freeDrawingBrush.width = drawingBrush.width;
            canvas.freeDrawingBrush.opacity = 1.0;
            
            // Ghi đè phương thức _render để sử dụng globalCompositeOperation
            const originalRender = canvas.freeDrawingBrush._render;
            canvas.freeDrawingBrush._render = function() {
                const ctx = this.canvas.contextTop;
                ctx.globalCompositeOperation = 'destination-out';
                originalRender.call(this);
                ctx.globalCompositeOperation = 'source-over';
            };
            
            // Hiển thị bảng điều khiển vẽ
            document.getElementById('drawingControls').style.display = 'flex';
            
            updateToolButtons();
            updateStatus('Chế độ xóa tự do - Kéo chuột để xóa');
            updateDrawingToolStatus('Xóa tự do');
        }
        
        function deactivateDrawingMode() {
            canvas.isDrawingMode = false;
            canvas.selection = true;
            
            // Ẩn bảng điều khiển vẽ
            document.getElementById('drawingControls').style.display = 'none';
            
            // Reset brush về mặc định
            if (canvas.freeDrawingBrush && canvas.freeDrawingBrush._render) {
                delete canvas.freeDrawingBrush._render;
            }
        }
        
        function updateDrawingToolStatus(toolName) {
            document.getElementById('drawingToolStatus').textContent = toolName;
            document.getElementById('drawingToolStatus').style.color = '#4ecdc4';
        }
        
        // Sự kiện cho nút vẽ
        document.getElementById('drawBtn').addEventListener('click', function() {
            if (currentToolMode === 'draw') {
                setToolMode('select');
            } else {
                setToolMode('draw');
            }
        });
        
        // Sự kiện cho nút xóa
        document.getElementById('eraseBtn').addEventListener('click', function() {
            if (currentToolMode === 'erase') {
                setToolMode('select');
            } else {
                setToolMode('erase');
            }
        });
        
        // Cập nhật màu vẽ
        document.getElementById('drawingColor').addEventListener('input', function(e) {
            drawingBrush.color = e.target.value;
            if (currentToolMode === 'draw') {
                canvas.freeDrawingBrush.color = drawingBrush.color;
            }
            // Cập nhật màu của color picker
            e.target.style.background = drawingBrush.color;
        });
        
        // Cập nhật độ rộng nét vẽ
        document.getElementById('drawingWidth').addEventListener('input', function(e) {
            drawingBrush.width = parseInt(e.target.value);
            document.getElementById('drawingWidthValue').textContent = drawingBrush.width + 'px';
            
            if (currentToolMode === 'draw' || currentToolMode === 'erase') {
                canvas.freeDrawingBrush.width = drawingBrush.width;
            }
        });
        
        // Cập nhật độ mờ
        document.getElementById('drawingOpacity').addEventListener('input', function(e) {
            drawingBrush.opacity = parseInt(e.target.value) / 100;
            document.getElementById('drawingOpacityValue').textContent = e.target.value + '%';
            
            if (currentToolMode === 'draw') {
                canvas.freeDrawingBrush.opacity = drawingBrush.opacity;
            }
        });
        
        // Xóa tất cả nét vẽ
        document.getElementById('clearDrawing').addEventListener('click', function() {
            const drawingObjects = canvas.getObjects().filter(obj => 
                obj.type === 'path' && obj.name === 'free_drawing'
            );
            
            drawingObjects.forEach(obj => {
                canvas.remove(obj);
            });
            
            canvas.renderAll();
            saveToHistory();
            updateStatus('Đã xóa tất cả nét vẽ');
        });
        
        // Đánh dấu các đối tượng vẽ tự do
        canvas.on('path:created', function(e) {
            e.path.name = 'free_drawing';
            saveToHistory();
        });

        // ========== CHUYỂN ĐỔI CÔNG CỤ (SELECT/HAND/DRAW/ERASE) ==========
        function setToolMode(mode) {
            // Tắt chế độ vẽ hiện tại nếu có
            if (currentToolMode === 'draw' || currentToolMode === 'erase') {
                deactivateDrawingMode();
            }
            
            currentToolMode = mode;
            
            // Xóa trạng thái active của tất cả các nút công cụ
            document.querySelectorAll('.tools .tool-btn').forEach(btn => {
                btn.classList.remove('active-tool');
            });

            if (mode === 'hand') {
                document.getElementById('handToolBtn').classList.add('active-tool');
                canvas.selection = false;
                canvas.defaultCursor = 'grab';
                canvas.hoverCursor = 'grab';
                updateStatus('Chế độ Bàn Tay (Pan) được kích hoạt');
                updateDrawingToolStatus('Bàn tay');
            } else if (mode === 'draw') {
                document.getElementById('drawBtn').classList.add('active-tool');
                activateDrawingMode();
            } else if (mode === 'erase') {
                document.getElementById('eraseBtn').classList.add('active-tool');
                activateErasingMode();
            } else { // mode === 'select'
                document.getElementById('transformBtn').classList.add('active-tool');
                canvas.selection = true;
                canvas.defaultCursor = 'default';
                canvas.hoverCursor = 'move';
                updateStatus('Chế độ Select/Transform được kích hoạt');
                updateDrawingToolStatus('Select');
            }
            canvas.renderAll();
        }

        document.getElementById('handToolBtn').addEventListener('click', () => setToolMode('hand'));
        document.getElementById('transformBtn').addEventListener('click', () => setToolMode('select'));

        // ========== NÂNG CẤP: ZOOM & PAN ==========
        let isPanning = false;

        // Bắt sự kiện khi nhấn và nhả chuột trên Canvas (Kích hoạt Pan)
        canvas.on('mouse:down', function(opt) {
            const evt = opt.e;
            // Không pan nếu đang ở chế độ vẽ/xóa
            if (currentToolMode === 'draw' || currentToolMode === 'erase') {
                return;
            }
            
            // Kích hoạt Pan khi nhấn Ctrl/Alt HOẶC khi đang ở chế độ Hand
            if (evt.ctrlKey || evt.altKey || currentToolMode === 'hand') { 
                isPanning = true;
                canvas.selection = false; 
                canvas.lastPosX = evt.clientX;
                canvas.lastPosY = evt.clientY;
                if (currentToolMode === 'hand') {
                    canvas.defaultCursor = 'grabbing';
                }
            }
        });

        canvas.on('mouse:move', function(opt) {
            if (isPanning && zoomLevel >= 1) {
                const evt = opt.e;
                const vpt = canvas.viewportTransform;
                
                vpt[4] += evt.clientX - canvas.lastPosX;
                vpt[5] += evt.clientY - canvas.lastPosY;
                
                // Giới hạn Pan
                limitPan(vpt);

                canvas.requestRenderAll();
                
                canvas.lastPosX = evt.clientX;
                canvas.lastPosY = evt.lastPosY = evt.clientY;
            }
        });

        canvas.on('mouse:up', function(opt) {
            isPanning = false;
            if (currentToolMode === 'select') {
                canvas.selection = true;
                canvas.defaultCursor = 'default';
            } else if (currentToolMode === 'hand') {
                 canvas.defaultCursor = 'grab';
                 canvas.selection = false; 
            }
            canvas.setViewportTransform(canvas.viewportTransform); 
        });

        // HÀM MỚI: Giới hạn Pan Viewport Transform
        function limitPan(vpt) {
            const viewportWidth = canvas.getWidth();
            const viewportHeight = canvas.getHeight();
            const maxOffsetX = viewportWidth * (zoomLevel - 1) * 0.5;
            const maxOffsetY = viewportHeight * (zoomLevel - 1) * 0.5;

            if (vpt[4] > maxOffsetX) {
                vpt[4] = maxOffsetX;
            } else if (vpt[4] < -maxOffsetX) {
                vpt[4] = -maxOffsetX;
            }

            if (vpt[5] > maxOffsetY) {
                vpt[5] = maxOffsetY;
            } else if (vpt[5] < -maxOffsetY) {
                vpt[5] = -maxOffsetY;
            }
        }

        // Bắt sự kiện Scroll Wheel (Zoom theo con trỏ chuột)
        canvas.on('mouse:wheel', function(opt) {
            const delta = opt.e.deltaY;
            let newZoom = zoomLevel;

            if (delta > 0) {
                newZoom /= 1.1;
            } else if (delta < 0) {
                newZoom *= 1.1;
            }

            newZoom = Math.min(5, Math.max(0.1, newZoom));
            
            canvas.zoomToPoint({ x: opt.e.offsetX, y: opt.e.offsetY }, newZoom);
            zoomLevel = newZoom;
            
            limitPan(canvas.viewportTransform);

            updateZoomDisplay();
            opt.e.preventDefault(); 
            opt.e.stopPropagation();
        });

        function updateZoomDisplay() {
            const percent = Math.round(zoomLevel * 100);
            document.getElementById('zoomLevel').textContent = percent + '%';
            document.getElementById('zoomStatus').textContent = percent + '%';
            canvas.renderAll();
        }
        
        function zoomToPoint(point, newZoom) {
            zoomLevel = Math.min(5, Math.max(0.1, newZoom));
            canvas.zoomToPoint(point, zoomLevel);
            updateZoomDisplay();
        }
        
        function resetZoom() { 
            canvas.setViewportTransform([1, 0, 0, 1, 0, 0]);
            zoomLevel = 1;
            canvas.setZoom(1);
            updateZoomDisplay();
            updateStatus("Zoom đã reset về 100%"); 
        }

        document.getElementById('zoomInCanvas').addEventListener('click', () => zoomToPoint(canvas.getCenter(), zoomLevel * 1.2));
        document.getElementById('zoomOutCanvas').addEventListener('click', () => zoomToPoint(canvas.getCenter(), zoomLevel * 0.8));
        document.getElementById('zoomResetCanvas').addEventListener('click', resetZoom);

        // ========== UPLOAD FUNCTIONS (ĐÃ SỬA LỖI) ==========
        // 1. UPLOAD MOCKUP
        document.getElementById('uploadMockupBtn').addEventListener('click', function() {
            console.log('Upload mockup clicked');
            document.getElementById('mockupFile').click();
        });

        document.getElementById('mockupFile').addEventListener('change', function(e) {
            console.log('Mockup file selected');
            if (e.target.files && e.target.files[0]) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    console.log('Mockup file loaded');
                    if (mockupImage) {
                        canvas.remove(mockupImage);
                    }
                    
                    fabric.Image.fromURL(event.target.result, function(img) {
                        mockupImage = img;
                        mockupImage.set({ 
                            selectable: false, 
                            evented: false, 
                            hasControls: false, 
                            hasBorders: false, 
                            name: 'mockup_bg' 
                        });
                        
                        const scale = Math.min(canvas.width / img.width, canvas.height / img.height) * 0.9;
                        
                        img.scale(scale);
                        img.set({
                            left: (canvas.width - img.width * scale) / 2,
                            top: (canvas.height - img.height * scale) / 2
                        });
                        
                        canvas.add(img);
                        canvas.sendToBack(img);
                        updateStatus('Mockup đã được tải lên!');
                        saveToHistory();
                    });
                };
                reader.readAsDataURL(e.target.files[0]);
            }
        });
        
        // 2. UPLOAD DISPLACEMENT MAP
        document.getElementById('uploadDisplacementBtn').addEventListener('click', function() {
            console.log('Upload displacement clicked');
            document.getElementById('displacementFile').click();
        });

        document.getElementById('displacementFile').addEventListener('change', function(e) {
            console.log('Displacement file selected');
            if (e.target.files && e.target.files[0]) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    console.log('Displacement file loaded');
                    const img = new Image();
                    img.onload = function() {
                        displacementMap = img;
                        updateStatus('Displacement Map đã được tải lên, sẵn sàng cho Warp!');
                    };
                    img.src = event.target.result;
                };
                reader.readAsDataURL(e.target.files[0]);
            }
        });

        // 3. UPLOAD VẬT LIỆU
        document.getElementById('uploadTextureBtn').addEventListener('click', function() {
            console.log('Upload texture clicked');
            document.getElementById('textureFiles').click();
        });

        document.getElementById('textureFiles').addEventListener('change', function(e) {
            console.log('Texture files selected');
            const files = Array.from(e.target.files);
            const thumbnailsContainer = document.getElementById('textureThumbnails');
            
            files.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = function(event) {
                    textures.push({
                        id: Date.now() + index,
                        url: event.target.result,
                        name: file.name
                    });
                    
                    const thumbnail = document.createElement('img');
                    thumbnail.src = event.target.result;
                    thumbnail.className = 'thumbnail';
                    thumbnail.draggable = true;
                    thumbnail.dataset.index = textures.length - 1;
                    
                    thumbnail.addEventListener('dragstart', function(e) {
                        e.dataTransfer.setData('textureIndex', this.dataset.index);
                    });
                    thumbnailsContainer.appendChild(thumbnail);
                };
                reader.readAsDataURL(file);
            });
            updateStatus(`Đã tải lên ${files.length} ảnh vật liệu`);
        });

        // KÉO THẢ VÀO CANVAS (ĐÃ SỬA LỖI - THÊM ĐIỀU KIỆN CHẾ ĐỘ VẼ/XÓA)
        canvas.on('drop', function(event) {
            // Không xử lý drop nếu đang ở chế độ vẽ/xóa
            if (currentToolMode === 'draw' || currentToolMode === 'erase') {
                return;
            }
            
            event.e.preventDefault();
            
            const textureIndex = event.e.dataTransfer.getData('textureIndex');
            if (textureIndex === '') return;
            
            const index = parseInt(textureIndex);
            if (textures[index]) {
                const texture = textures[index];
                
                fabric.Image.fromURL(texture.url, function(img) {
                    const scale = 200 / Math.max(img.width, img.height);
                    
                    img.set({
                        left: event.e.offsetX - (img.width * scale) / 2,
                        top: event.e.offsetY - (img.height * scale) / 2,
                        scaleX: scale,
                        scaleY: scale,
                        globalCompositeOperation: 'multiply', 
                        hasControls: true,
                        hasBorders: true,
                        cornerStyle: 'circle',
                        cornerColor: '#4ecdc4',
                        borderColor: '#4ecdc4',
                        cornerSize: 12,
                        transparentCorners: false,
                        name: 'texture' 
                    });
                    
                    canvas.add(img);
                    canvas.setActiveObject(img);
                    updateStatus(`Đã thêm "${texture.name}" vào mockup`);
                    updateSelectedObject();
                    saveToHistory();
                });
            }
        });

        canvas.on('dragover', function(event) { 
            event.e.preventDefault(); 
        });
        
        // ========== 4. FIT THEO BỀ MẶT NÂNG CAO ==========
        document.getElementById('fitSurfaceBtn').addEventListener('click', function() {
            const activeObj = canvas.getActiveObject();
            if (!activeObj || !mockupImage) {
                updateStatus('Cần có mockup và vật liệu để fit bề mặt');
                return;
            }
            
            const mockupBounds = mockupImage.getBoundingRect();
            const fitScale = 0.8;
            
            const targetWidth = mockupBounds.width * fitScale;
            const targetHeight = mockupBounds.height * fitScale;
            
            const scaleX = targetWidth / activeObj.width;
            const scaleY = targetHeight / activeObj.height;
            const scale = Math.min(scaleX, scaleY);
            
            activeObj.set({
                scaleX: scale,
                scaleY: scale,
                left: mockupBounds.left + (mockupBounds.width - activeObj.width * scale) / 2,
                top: mockupBounds.top + (mockupBounds.height - activeObj.height * scale) / 2,
                angle: 0,
                skewX: 0,
                skewY: 0,
                opacity: 0.9,
                globalCompositeOperation: 'multiply'
            });
            
            activeObj.setCoords();
            canvas.renderAll();
            updateStatus('Đã fit ảnh theo bề mặt mockup');
            saveToHistory();
        });

        // ========== 5. WARP BỀ MẶT - THUẬT TOÁN NÂNG CAO (GLFX.js) ==========
        const warpModal = document.getElementById('warpModal');
        const warpOverlay = document.getElementById('warpOverlay');
        
        // ========== MODAL DI CHUYỂN ĐƯỢC ==========
        let isDraggingModal = false;
        let modalDragOffsetX = 0;
        let modalDragOffsetY = 0;

        const modalHeader = warpModal.querySelector('.modal-header');
        modalHeader.addEventListener('mousedown', startDraggingModal);

        function startDraggingModal(e) {
            if (e.target.closest('.close-modal-btn')) return;
            
            isDraggingModal = true;
            
            const modalRect = warpModal.getBoundingClientRect();
            modalDragOffsetX = e.clientX - modalRect.left;
            modalDragOffsetY = e.clientY - modalRect.top;
            
            warpModal.style.cursor = 'grabbing';
            document.addEventListener('mousemove', dragModal);
            document.addEventListener('mouseup', stopDraggingModal);
        }

        function dragModal(e) {
            if (!isDraggingModal) return;
            
            e.preventDefault();
            
            const newLeft = e.clientX - modalDragOffsetX;
            const newTop = e.clientY - modalDragOffsetY;
            
            const maxX = window.innerWidth - warpModal.offsetWidth;
            const maxY = window.innerHeight - warpModal.offsetHeight;
            
            warpModal.style.left = Math.min(Math.max(0, newLeft), maxX) + 'px';
            warpModal.style.top = Math.min(Math.max(0, newTop), maxY) + 'px';
            warpModal.style.right = 'auto';
        }

        function stopDraggingModal() {
            isDraggingModal = false;
            warpModal.style.cursor = 'move';
            document.removeEventListener('mousemove', dragModal);
            document.removeEventListener('mouseup', stopDraggingModal);
        }

        document.getElementById('closeWarpModal').addEventListener('click', closeWarpModal);
        
        document.getElementById('warpSurfaceBtn').addEventListener('click', function() {
            if (!canvas.getActiveObject() || canvas.getActiveObject() === mockupImage) {
                updateStatus('Vui lòng chọn đối tượng cần warp');
                return;
            }
            
            warpModal.style.left = 'auto';
            warpModal.style.right = '20px';
            warpModal.style.top = '20px';
            
            warpModal.classList.add('active');
            warpOverlay.classList.add('active');
            updateStatus('Đang mở công cụ Warp bề mặt');
            
            if (displacementMap) {
                 updateStatus('Displacement Map sẵn sàng. Kéo slider "Cường độ Displacement Map" để biến dạng theo nếp nhăn!');
            } else {
                 updateStatus('Chưa có Displacement Map. Hiệu ứng Warp sẽ chỉ dùng Bulge/Pinch cơ bản.');
            }
        });

        // Logic cập nhật slider
        const warpSliders = ['dispIntensitySlider', 'warpXSlider', 'warpYSlider', 'bulgeSlider', 'pinchSlider', 'waveSlider', 'blendSlider'];
        const warpValues = ['dispIntensityValue', 'warpXValue', 'warpYValue', 'bulgeValue', 'pinchValue', 'waveValue', 'blendValue'];
        
        warpSliders.forEach((sliderId, index) => {
            const slider = document.getElementById(sliderId);
            const valueDisplay = document.getElementById(warpValues[index]);
            
            slider.addEventListener('input', function() {
                valueDisplay.textContent = this.value;
                const settingKey = sliderId.replace('Slider', '').replace(/([A-Z])/g, match => match.toLowerCase());
                warpSettings[settingKey] = parseInt(this.value);
            });
        });

        // Presets warp
        document.querySelectorAll('.warp-preset').forEach(btn => {
            btn.addEventListener('click', function() {
                const preset = this.dataset.preset;
                
                switch(preset) {
                    case 'curve':
                        setWarpPreset(0, 20, 15, 30, 0, 0, 60);
                        break;
                    case 'displacement':
                         setWarpPreset(50, 0, 0, 0, 0, 0, 70);
                         break;
                    case 'bulge':
                        setWarpPreset(0, 0, 0, 80, 0, 0, 50);
                        break;
                    case 'pinch':
                        setWarpPreset(0, 0, 0, 0, 70, 0, 50);
                        break;
                    case 'fold':
                        setWarpPreset(0, -25, 30, 40, 20, 50, 80);
                        break;
                    case 'reset':
                        setWarpPreset(0, 0, 0, 0, 0, 0, 50);
                        break;
                }
            });
        });

        function setWarpPreset(dispIntensity, warpX, warpY, bulge, pinch, wave, blend) {
            warpSettings = { dispIntensity, warpX, warpY, bulge, pinch, wave, blend };
            
            document.getElementById('dispIntensitySlider').value = dispIntensity;
            document.getElementById('warpXSlider').value = warpX;
            document.getElementById('warpYSlider').value = warpY;
            document.getElementById('bulgeSlider').value = bulge;
            document.getElementById('pinchSlider').value = pinch;
            document.getElementById('waveSlider').value = wave;
            document.getElementById('blendSlider').value = blend;
            
            document.getElementById('dispIntensityValue').textContent = dispIntensity;
            document.getElementById('warpXValue').textContent = warpX;
            document.getElementById('warpYValue').textContent = warpY;
            document.getElementById('bulgeValue').textContent = bulge;
            document.getElementById('pinchValue').textContent = pinch;
            document.getElementById('waveValue').textContent = wave;
            document.getElementById('blendValue').textContent = blend;
        }

        // Áp dụng warp thực tế
        function applyWarpToObject(obj) {
            if (!obj || obj.getElement().tagName !== 'IMG') return;
            
            const originalState = obj.toJSON(['globalCompositeOperation']);
            
            const { dispIntensity, warpX, warpY, bulge, pinch, wave, blend } = warpSettings;
            
            const dispFactor = dispIntensity / 100 * 0.15; 
            const bulgeFactor = bulge / 100 * 0.5; 
            const pinchFactor = pinch / 100 * 0.3;
            const waveFactor = wave / 100 * 0.1;
            const blendFactor = blend / 100;
            
            const imgElement = obj.getElement();
            
            try {
                const fxCanvas = fx.canvas();
                const texture = fxCanvas.texture(imgElement);
                
                fxCanvas.draw(texture).update();
                
                if (dispFactor > 0 && displacementMap) {
                    const displacementTexture = fxCanvas.texture(displacementMap);
                    fxCanvas.heightField(displacementTexture, dispFactor).update();
                }
                
                const center = [0.5, 0.5];
                if (bulgeFactor > 0) {
                    fxCanvas.bulgePinch(center[0], center[1], bulgeFactor, 0.9).update();
                }
                if (pinchFactor > 0) {
                    fxCanvas.bulgePinch(center[0], center[1], -pinchFactor, 0.9).update();
                }
                
                if (waveFactor > 0) {
                    fxCanvas.swirl(center[0], center[1], waveFactor * 0.5, 0.5).update();
                }
                
                const warpedUrl = fxCanvas.toDataURL();
                
                fabric.Image.fromURL(warpedUrl, function(warpedImg) {
                    warpedImg.set({
                        ...originalState,
                        left: obj.left,
                        top: obj.top,
                        scaleX: obj.scaleX,
                        scaleY: obj.scaleY,
                        angle: obj.angle,
                        skewX: obj.skewX + warpX * 0.3,
                        skewY: obj.skewY + warpY * 0.3,
                        globalCompositeOperation: 'soft-light',
                        opacity: Math.max(0.6, 1 - (1 - blendFactor) * 0.4),
                        name: 'texture',
                        shadow: new fabric.Shadow({
                            color: `rgba(0,0,0,${0.2 + blendFactor * 0.3})`,
                            blur: 10 + bulge * 0.5,
                            offsetX: warpX * 0.1 + dispFactor * 20,
                            offsetY: warpY * 0.1 + dispFactor * 20
                        })
                    });
                    
                    canvas.remove(obj);
                    canvas.add(warpedImg);
                    canvas.setActiveObject(warpedImg);
                    canvas.renderAll();
                    updateStatus('Đã áp dụng hiệu ứng warp/lồi/lõm nâng cao!');
                    saveToHistory();
                });

            } catch (e) {
                updateStatus('Lỗi Warp: Vui lòng kiểm tra console. (Thường do trình duyệt chặn WebGL)');
                console.error('GLFX Warp Error:', e);
            }
        }

        // Áp dụng warp
        document.getElementById('applyWarp').addEventListener('click', function() {
            const activeObj = canvas.getActiveObject();
            if (activeObj) {
                applyWarpToObject(activeObj);
                closeWarpModal();
            }
        });

        document.getElementById('cancelWarp').addEventListener('click', closeWarpModal);
        warpOverlay.addEventListener('click', closeWarpModal);

        function closeWarpModal() {
            warpModal.classList.remove('active');
            warpOverlay.classList.remove('active');
        }

        // ========== 7. AUTO CÂN MÀU NÂNG CAO (ĐÃ SỬA LỖI) ==========
        document.getElementById('autoColorBtn').addEventListener('click', function() {
            console.log('Auto color button clicked');
            
            // Chuyển về chế độ select nếu đang ở chế độ vẽ/xóa
            if (currentToolMode === 'draw' || currentToolMode === 'erase') {
                setToolMode('select');
            }
            
            const activeObj = canvas.getActiveObject();
            console.log('Active object:', activeObj);
            
            if (!activeObj) {
                updateStatus('Vui lòng chọn một đối tượng để cân màu');
                return;
            }
            
            if (!mockupImage) {
                updateStatus('Cần có mockup để cân màu');
                return;
            }
            
            // Kiểm tra nếu đối tượng không phải là ảnh thì bỏ qua
            if (!(activeObj instanceof fabric.Image)) {
                updateStatus('Vui lòng chọn một hình ảnh để cân màu');
                return;
            }
            
            updateStatus('Đang phân tích và cân màu nâng cao...');
            
            // Lấy màu trung bình từ mockup (đơn giản hóa)
            const avgLuminance = 0.6;
            
            const targetBrightness = (0.5 - avgLuminance) * 0.1; 
            const targetContrast = (avgLuminance - 0.5) * 0.2; 
            
            // Áp dụng các bộ lọc màu
            activeObj.filters = [
                new fabric.Image.filters.Brightness({ brightness: targetBrightness + 0.05 }),
                new fabric.Image.filters.Contrast({ contrast: targetContrast + 0.1 }),
                new fabric.Image.filters.Saturation({ saturation: -0.15 }),
                new fabric.Image.filters.BlendColor({
                    color: '#000000', 
                    mode: 'multiply', 
                    alpha: 0.15
                }),
                new fabric.Image.filters.ColorMatrix({
                    matrix: [
                        1.05, 0, 0, 0, 0,    
                        0, 1.05, 0, 0, 0,    
                        0, 0, 1.05, 0, 0,    
                        0, 0, 0, 1, 0        
                    ]
                })
            ];
            
            activeObj.set({ globalCompositeOperation: 'soft-light' });
            
            activeObj.applyFilters();
            canvas.renderAll();
            updateStatus('Đã cân màu nâng cao và áp dụng filter hòa trộn');
            saveToHistory();
        });

        // ========== CHỨC NĂNG LƯU/XUẤT FILE ==========
        const saveModal = document.getElementById('saveModal');
        const saveOverlay = document.getElementById('saveOverlay');
        
        document.getElementById('saveBtn').addEventListener('click', function() {
            saveModal.classList.add('active');
            saveOverlay.classList.add('active');
            updateStatus('Mở hộp thoại xuất file');
        });

        document.getElementById('cancelSave').addEventListener('click', closeSaveModal);
        saveOverlay.addEventListener('click', closeSaveModal);

        function closeSaveModal() {
            saveModal.classList.remove('active');
            saveOverlay.classList.remove('active');
        }

        document.getElementById('confirmSave').addEventListener('click', function() {
            const format = document.getElementById('exportFormat').value;
            const fileName = document.getElementById('exportFileName').value || 'mockup_k_pro';
            
            updateStatus('Đang tạo hình ảnh xuất file, vui lòng chờ...');
            
            const originalVpt = [...canvas.viewportTransform];
            const originalZoom = zoomLevel;
            
            canvas.discardActiveObject(); 
            
            canvas.getObjects().forEach(obj => {
                obj.hasControls = false;
                obj.hasBorders = false;
            });
            
            canvas.setViewportTransform([1, 0, 0, 1, 0, 0]);
            canvas.setZoom(1);
            canvas.renderAll();

            const dataURL = canvas.toDataURL({
                format: format,
                quality: 0.95
            });

            setTimeout(() => {
                canvas.setViewportTransform(originalVpt);
                canvas.setZoom(originalZoom);
                zoomLevel = originalZoom;
                updateZoomDisplay();
                
                canvas.getObjects().forEach(obj => {
                    if (obj.name === 'texture') {
                        obj.hasControls = true;
                        obj.hasBorders = true;
                    }
                });
                canvas.renderAll();
                
                const link = document.createElement('a');
                link.href = dataURL;
                link.download = `${fileName}.${format}`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                updateStatus(`Đã xuất file ${fileName}.${format} thành công!`);
                closeSaveModal();

            }, 50); 
        });

        // ========== CÁC CÔNG CỤ KHÁC ==========
        document.getElementById('removeBtn').addEventListener('click', function() {
            const activeObj = canvas.getActiveObject();
            if (activeObj && activeObj !== mockupImage) {
                canvas.remove(activeObj);
                updateStatus('Đã xóa đối tượng');
                updateSelectedObject();
                saveToHistory();
            }
        });

        document.getElementById('bringFrontBtn').addEventListener('click', function() {
            const activeObj = canvas.getActiveObject();
            if (activeObj) {
                activeObj.bringToFront();
                canvas.renderAll();
                updateStatus('Đã đưa lên lớp trên');
                saveToHistory();
            }
        });

        document.getElementById('sendBackBtn').addEventListener('click', function() {
            const activeObj = canvas.getActiveObject();
            if (activeObj && activeObj !== mockupImage) {
                activeObj.sendToBack();
                if (mockupImage) mockupImage.sendToBack();
                canvas.renderAll();
                updateStatus('Đã đưa xuống lớp dưới');
                saveToHistory();
            }
        });

        document.getElementById('undoBtn').addEventListener('click', function() {
             if (historyIndex > 0) {
                historyIndex--;
                canvas.loadFromJSON(history[historyIndex], function() {
                    canvas.renderAll();
                    updateSelectedObject();
                    updateStatus(`Đã undo (${historyIndex}/${history.length-1})`);
                    updateHistoryButtons();
                    updateHistoryStatus();
                });
            }
        });
        document.getElementById('redoBtn').addEventListener('click', function() {
            if (historyIndex < history.length - 1) {
                historyIndex++;
                canvas.loadFromJSON(history[historyIndex], function() {
                    canvas.renderAll();
                    updateSelectedObject();
                    updateStatus(`Đã redo (${historyIndex}/${history.length-1})`);
                    updateHistoryButtons();
                    updateHistoryStatus();
                });
            }
        });

        // ========== PHÍM TẮT & THEO DÕI ĐỐI TƯỢNG ==========
        document.addEventListener('keydown', function(e) {
            if (e.key.toLowerCase() === 'h' && currentToolMode !== 'hand') { 
                e.preventDefault(); 
                setToolMode('hand');
            } else if (e.key === 'Escape' || (e.ctrlKey && e.key === 't')) { 
                e.preventDefault(); 
                setToolMode('select');
            } else if (e.key.toLowerCase() === 'd') { 
                e.preventDefault(); 
                if (currentToolMode === 'draw') {
                    setToolMode('select');
                } else {
                    setToolMode('draw');
                }
            } else if (e.key.toLowerCase() === 'e') { 
                e.preventDefault(); 
                if (currentToolMode === 'erase') {
                    setToolMode('select');
                } else {
                    setToolMode('erase');
                }
            } else if (e.ctrlKey && e.key === 'z') { 
                e.preventDefault(); 
                document.getElementById('undoBtn').click(); 
            } else if ((e.ctrlKey && e.key === 'y') || (e.ctrlKey && e.shiftKey && e.key === 'Z')) { 
                e.preventDefault(); 
                document.getElementById('redoBtn').click(); 
            } else if (e.key === 'Delete' || e.key === 'Backspace') {
                e.preventDefault(); 
                document.getElementById('removeBtn').click(); 
            }
        });

        canvas.on('selection:created', updateSelectedObject);
        canvas.on('selection:updated', updateSelectedObject);
        canvas.on('selection:cleared', updateSelectedObject);

        function updateSelectedObject() {
            const activeObj = canvas.getActiveObject();
            const selectedObjElement = document.getElementById('selectedObj');
            
            if (activeObj && activeObj !== mockupImage) {
                selectedObjElement.textContent = activeObj.name === 'texture' ? 'Vật Liệu' : 'Đã chọn';
                selectedObjElement.style.color = '#4ecdc4';
            } else {
                selectedObjElement.textContent = 'Không có';
                selectedObjElement.style.color = '#ff6b6b';
            }
        }
        
        function updateStatus(message) {
            document.getElementById('statusText').textContent = message;
        }

        // ========== KHỞI TẠO ==========
        setToolMode('select');
        updateZoomDisplay();
        updateStatus('Sẵn sàng - Tải mockup và ảnh vật liệu để bắt đầu');
        updateSelectedObject();
        updateHistoryButtons();
        updateHistoryStatus();
        
        // Khởi tạo màu cho color picker
        document.getElementById('drawingColor').style.background = drawingBrush.color;
        
        setTimeout(() => {
            saveToHistory();
        }, 100);
    </script>
</body>
</html>
