// ========== THÊM BIẾN TOÀN CỤC MỚI ==========
let currentErasingMode = 'texture'; // 'texture' hoặc 'canvas'
let currentTextureToErase = null;
let isErasing = false;
let erasePoints = [];

// ========== CẬP NHẬT CÔNG CỤ VẼ/XÓA ==========
function activateDrawingMode() {
    currentToolMode = 'draw';
    canvas.isDrawingMode = true;
    canvas.selection = false;
    
    canvas.freeDrawingBrush = new fabric.PencilBrush(canvas);
    canvas.freeDrawingBrush.color = drawingBrush.color;
    canvas.freeDrawingBrush.width = drawingBrush.width;
    canvas.freeDrawingBrush.opacity = drawingBrush.opacity;
    
    document.getElementById('drawingControls').style.display = 'flex';
    updateToolButtons();
    updateStatus('Chế độ vẽ tự do - Kéo chuột để vẽ trên canvas');
}

function activateTextureEraseMode() {
    currentToolMode = 'textureErase';
    canvas.isDrawingMode = false;
    canvas.selection = false;
    
    const activeObj = canvas.getActiveObject();
    if (!activeObj || activeObj.name !== 'texture') {
        updateStatus('Vui lòng chọn một vật liệu (texture) để xóa phần thừa');
        setToolMode('select');
        return;
    }
    
    currentTextureToErase = activeObj;
    erasePoints = [];
    
    // Hiển thị thông báo đặc biệt cho chế độ xóa texture
    document.getElementById('drawingControls').style.display = 'flex';
    document.getElementById('drawingControls').innerHTML = `
        <div style="color: #4ecdc4; font-weight: bold; margin-bottom: 10px;">
            <i class="fas fa-cut"></i> XÓA PHẦN THỪA VẬT LIỆU
        </div>
        <div class="drawing-control">
            <label>Độ rộng:</label>
            <input type="range" id="eraseWidth" min="1" max="100" value="20">
            <span id="eraseWidthValue" style="color: white; min-width: 30px;">20px</span>
        </div>
        <div class="drawing-control">
            <label>Độ mờ:</label>
            <input type="range" id="eraseOpacity" min="0" max="100" value="100">
            <span id="eraseOpacityValue" style="color: white; min-width: 30px;">100%</span>
        </div>
        <div class="drawing-mode-tabs">
            <button class="drawing-mode-tab active" data-mode="erase">Xóa</button>
            <button class="drawing-mode-tab" data-mode="restore">Khôi phục</button>
        </div>
        <button class="history-btn" id="applyTextureMask" style="margin-top: 10px;">
            <i class="fas fa-check"></i> Áp dụng mặt nạ
        </button>
        <button class="history-btn" id="cancelTextureErase" style="margin-top: 5px;">
            <i class="fas fa-times"></i> Hủy
        </button>
    `;
    
    // Khởi tạo các sự kiện mới
    document.getElementById('eraseWidth').addEventListener('input', function(e) {
        drawingBrush.width = parseInt(e.target.value);
        document.getElementById('eraseWidthValue').textContent = drawingBrush.width + 'px';
    });
    
    document.getElementById('eraseOpacity').addEventListener('input', function(e) {
        drawingBrush.opacity = parseInt(e.target.value) / 100;
        document.getElementById('eraseOpacityValue').textContent = e.target.value + '%';
    });
    
    document.querySelectorAll('.drawing-mode-tab').forEach(tab => {
        tab.addEventListener('click', function() {
            document.querySelectorAll('.drawing-mode-tab').forEach(t => {
                t.classList.remove('active');
            });
            this.classList.add('active');
            currentErasingMode = this.dataset.mode;
            updateStatus(`Chế độ: ${currentErasingMode === 'erase' ? 'Xóa phần thừa' : 'Khôi phục phần đã xóa'}`);
        });
    });
    
    document.getElementById('applyTextureMask').addEventListener('click', applyTextureMask);
    document.getElementById('cancelTextureErase').addEventListener('click', () => setToolMode('select'));
    
    // Thiết lập sự kiện chuột cho xóa texture
    setupTextureEraseEvents();
    
    updateToolButtons();
    updateStatus('Chế độ xóa phần thừa vật liệu - Vẽ để xóa phần không mong muốn');
}

function setupTextureEraseEvents() {
    canvas.off('mouse:down');
    canvas.off('mouse:move');
    canvas.off('mouse:up');
    
    canvas.on('mouse:down', startTextureErase);
    canvas.on('mouse:move', doTextureErase);
    canvas.on('mouse:up', stopTextureErase);
}

function startTextureErase(event) {
    if (!currentTextureToErase || currentToolMode !== 'textureErase') return;
    
    isErasing = true;
    const pointer = canvas.getPointer(event.e);
    
    // Kiểm tra xem có click vào texture không
    const target = canvas.findTarget(event.e);
    if (target !== currentTextureToErase) {
        updateStatus('Vui lòng vẽ trực tiếp lên vật liệu cần chỉnh sửa');
        return;
    }
    
    // Lấy tọa độ tương đối so với texture
    const localPoint = getLocalTexturePoint(pointer.x, pointer.y, currentTextureToErase);
    erasePoints = [[localPoint.x, localPoint.y]];
    
    // Tạo preview đường vẽ tạm thời
    createErasePreview(localPoint.x, localPoint.y);
}

function doTextureErase(event) {
    if (!isErasing || !currentTextureToErase) return;
    
    const pointer = canvas.getPointer(event.e);
    const localPoint = getLocalTexturePoint(pointer.x, pointer.y, currentTextureToErase);
    
    // Thêm điểm vào mảng
    erasePoints.push([localPoint.x, localPoint.y]);
    
    // Cập nhật preview
    updateErasePreview(localPoint.x, localPoint.y);
}

function stopTextureErase() {
    if (!isErasing || !currentTextureToErase) return;
    
    isErasing = false;
    
    // Nếu có đủ điểm, tạo mặt nạ
    if (erasePoints.length > 2) {
        createTextureMask();
    }
    
    // Xóa preview
    clearErasePreview();
}

function getLocalTexturePoint(canvasX, canvasY, texture) {
    // Chuyển đổi tọa độ canvas sang tọa độ local của texture
    const matrix = texture.calcTransformMatrix();
    const invertedMatrix = fabric.util.invertTransform(matrix);
    const point = new fabric.Point(canvasX, canvasY);
    const transformedPoint = fabric.util.transformPoint(point, invertedMatrix);
    
    return {
        x: transformedPoint.x / texture.scaleX,
        y: transformedPoint.y / texture.scaleY
    };
}

function createErasePreview(x, y) {
    // Tạo một đường vẽ tạm thời để preview
    const previewCircle = new fabric.Circle({
        left: x,
        top: y,
        radius: drawingBrush.width / 2,
        fill: currentErasingMode === 'erase' ? 'rgba(255, 0, 0, 0.5)' : 'rgba(0, 255, 0, 0.5)',
        selectable: false,
        evented: false,
        name: 'erase_preview'
    });
    
    canvas.add(previewCircle);
    canvas.renderAll();
}

function updateErasePreview(x, y) {
    // Xóa preview cũ
    const previews = canvas.getObjects().filter(obj => obj.name === 'erase_preview');
    previews.forEach(obj => canvas.remove(obj));
    
    // Tạo preview mới
    createErasePreview(x, y);
    
    // Vẽ đường line từ điểm trước
    if (erasePoints.length > 1) {
        const prevPoint = erasePoints[erasePoints.length - 2];
        const line = new fabric.Line([
            prevPoint[0], prevPoint[1],
            x, y
        ], {
            stroke: currentErasingMode === 'erase' ? 'rgba(255, 0, 0, 0.3)' : 'rgba(0, 255, 0, 0.3)',
            strokeWidth: drawingBrush.width,
            selectable: false,
            evented: false,
            name: 'erase_line'
        });
        
        canvas.add(line);
    }
}

function clearErasePreview() {
    const previews = canvas.getObjects().filter(obj => 
        obj.name === 'erase_preview' || obj.name === 'erase_line'
    );
    previews.forEach(obj => canvas.remove(obj));
    canvas.renderAll();
}

function createTextureMask() {
    if (!currentTextureToErase || erasePoints.length < 3) return;
    
    // Tạo một canvas ẩn để xử lý mask
    const maskCanvas = document.createElement('canvas');
    const ctx = maskCanvas.getContext('2d');
    
    // Đặt kích thước bằng texture
    maskCanvas.width = currentTextureToErase.width;
    maskCanvas.height = currentTextureToErase.height;
    
    // Vẽ mask (trắng = giữ lại, đen = xóa)
    ctx.fillStyle = 'white';
    ctx.fillRect(0, 0, maskCanvas.width, maskCanvas.height);
    
    if (currentErasingMode === 'erase') {
        // Chế độ xóa: vẽ đường đen để đánh dấu vùng cần xóa
        ctx.strokeStyle = 'black';
        ctx.lineWidth = drawingBrush.width;
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';
        
        ctx.beginPath();
        ctx.moveTo(erasePoints[0][0], erasePoints[0][1]);
        
        for (let i = 1; i < erasePoints.length; i++) {
            ctx.lineTo(erasePoints[i][0], erasePoints[i][1]);
        }
        
        ctx.stroke();
        
        // Làm mờ đường viền để tạo hiệu ứng mượt
        ctx.filter = `blur(${drawingBrush.width / 4}px)`;
        ctx.stroke();
        ctx.filter = 'none';
    } else {
        // Chế độ khôi phục: vẽ đường trắng để khôi phục vùng đã xóa
        ctx.strokeStyle = 'white';
        ctx.lineWidth = drawingBrush.width;
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';
        
        ctx.beginPath();
        ctx.moveTo(erasePoints[0][0], erasePoints[0][1]);
        
        for (let i = 1; i < erasePoints.length; i++) {
            ctx.lineTo(erasePoints[i][0], erasePoints[i][1]);
        }
        
        ctx.stroke();
    }
    
    // Tạo fabric.Image từ mask
    fabric.Image.fromURL(maskCanvas.toDataURL(), function(maskImg) {
        // Áp dụng mask cho texture
        currentTextureToErase.filters.push(
            new fabric.Image.filters.Mask({
                mask: maskImg,
                channel: 0 // Sử dụng kênh red (0) làm mask
            })
        );
        
        currentTextureToErase.applyFilters();
        canvas.renderAll();
        
        updateStatus(`Đã ${currentErasingMode === 'erase' ? 'xóa' : 'khôi phục'} vùng được đánh dấu`);
    });
}

function applyTextureMask() {
    // Lưu vào history
    saveToHistory();
    setToolMode('select');
}

// ========== CẬP NHẬT HÀM setToolMode ==========
function setToolMode(mode) {
    if (currentToolMode === 'draw') {
        deactivateDrawingMode();
    } else if (currentToolMode === 'textureErase') {
        // Dọn dẹp khi thoát chế độ xóa texture
        clearErasePreview();
        canvas.off('mouse:down');
        canvas.off('mouse:move');
        canvas.off('mouse:up');
        currentTextureToErase = null;
        document.getElementById('drawingControls').style.display = 'none';
        document.getElementById('drawingControls').innerHTML = `
            <div class="drawing-control">
                <label>Màu vẽ:</label>
                <input type="color" id="drawingColor" value="#4ecdc4" class="drawing-color-picker">
            </div>
            <div class="drawing-control">
                <label>Độ rộng:</label>
                <input type="range" id="drawingWidth" min="1" max="50" value="5">
                <span id="drawingWidthValue" style="color: white; min-width: 20px;">5px</span>
            </div>
            <div class="drawing-control">
                <label>Độ mờ:</label>
                <input type="range" id="drawingOpacity" min="0" max="100" value="100">
                <span id="drawingOpacityValue" style="color: white; min-width: 30px;">100%</span>
            </div>
            <button class="history-btn" id="clearDrawing" style="margin-top: 5px;">
                <i class="fas fa-broom"></i> Xóa nét vẽ
            </button>
        `;
    }
    
    currentToolMode = mode;
    
    document.querySelectorAll('.tools .tool-btn').forEach(btn => {
        btn.classList.remove('active-tool');
    });

    if (mode === 'hand') {
        document.getElementById('handToolBtn').classList.add('active-tool');
        canvas.selection = false;
        canvas.defaultCursor = 'grab';
        canvas.hoverCursor = 'grab';
        updateStatus('Chế độ Bàn Tay (Pan) được kích hoạt');
    } else if (mode === 'draw') {
        document.getElementById('drawBtn').classList.add('active-tool');
        activateDrawingMode();
    } else if (mode === 'erase') {
        document.getElementById('eraseBtn').classList.add('active-tool');
        activateTextureEraseMode();
    } else if (mode === 'textureErase') {
        document.getElementById('eraseBtn').classList.add('active-tool');
        activateTextureEraseMode();
    } else {
        document.getElementById('transformBtn').classList.add('active-tool');
        canvas.selection = true;
        canvas.defaultCursor = 'default';
        canvas.hoverCursor = 'move';
        updateStatus('Chế độ Select/Transform được kích hoạt');
    }
    canvas.renderAll();
}

// ========== CẬP NHẬT SỰ KIỆN NÚT ==========
document.getElementById('eraseBtn').addEventListener('click', function() {
    if (currentToolMode === 'textureErase' || currentToolMode === 'erase') {
        setToolMode('select');
    } else {
        // Kiểm tra nếu có vật liệu được chọn
        const activeObj = canvas.getActiveObject();
        if (activeObj && activeObj.name === 'texture') {
            setToolMode('textureErase');
        } else {
            updateStatus('Vui lòng chọn một vật liệu (texture) trước khi sử dụng công cụ xóa phần thừa');
        }
    }
});
