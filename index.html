<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MOCKUP K - Professional Mockup Editor</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/4.5.0/fabric.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/camanjs/4.1.2/caman.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/glfx.js/0.0.8/fx.js"></script>
    
    <style>
        /* ... (giữ nguyên CSS cũ) ... */

        /* MODAL TẠO DISPLACEMENT MAP */
        .disp-creation-modal {
            display: none;
            position: fixed;
            z-index: 1003;
            background: rgba(30, 30, 50, 0.98);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.8);
            border: 1px solid rgba(78, 205, 196, 0.5);
            backdrop-filter: blur(10px);
            width: 800px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .disp-creation-modal.active {
            display: block;
        }

        .disp-preview-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }

        .disp-preview-box {
            background: rgba(40, 40, 60, 0.8);
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }

        .disp-preview-box h4 {
            color: #4ecdc4;
            margin: 0 0 10px 0;
            font-size: 1em;
        }

        .disp-canvas {
            max-width: 100%;
            max-height: 300px;
            border: 2px solid #4ecdc4;
            border-radius: 5px;
            background: #1c2a35;
        }

        .disp-controls {
            background: rgba(60, 60, 100, 0.8);
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }

        .disp-slider-group {
            margin-bottom: 15px;
        }

        .disp-slider-label {
            display: flex;
            justify-content: space-between;
            color: #4ecdc4;
            margin-bottom: 5px;
            font-size: 0.9em;
        }

        .disp-slider-value {
            color: white;
            font-weight: bold;
        }

        .disp-preset-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin: 15px 0;
        }

        .disp-preset-btn {
            padding: 10px;
            background: rgba(70, 70, 120, 0.8);
            border: none;
            border-radius: 6px;
            color: white;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.85em;
        }

        .disp-preset-btn:hover {
            background: rgba(78, 205, 196, 0.8);
            transform: translateY(-2px);
        }

        .disp-preset-btn.active {
            background: #4ecdc4;
            color: #2c3e50;
            box-shadow: 0 0 10px rgba(78, 205, 196, 0.8);
        }

        /* PHOTOPEA IFRAME */
        .photopea-container {
            width: 100%;
            height: 600px;
            border: 2px solid #4ecdc4;
            border-radius: 8px;
            overflow: hidden;
            margin: 15px 0;
            background: white;
        }

        .photopea-container iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        .tab-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            border-bottom: 1px solid rgba(78, 205, 196, 0.3);
            padding-bottom: 10px;
        }

        .tab-btn {
            padding: 10px 20px;
            background: rgba(60, 60, 100, 0.8);
            border: none;
            border-radius: 6px;
            color: white;
            cursor: pointer;
            transition: all 0.3s;
        }

        .tab-btn:hover {
            background: rgba(78, 205, 196, 0.6);
        }

        .tab-btn.active {
            background: #4ecdc4;
            color: #2c3e50;
            font-weight: bold;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .info-box {
            background: rgba(78, 205, 196, 0.1);
            border: 1px solid rgba(78, 205, 196, 0.3);
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            color: #a9c7c7;
            font-size: 0.9em;
        }

        .info-box h4 {
            color: #4ecdc4;
            margin: 0 0 10px 0;
            font-size: 1em;
        }

        .info-box ul {
            margin: 10px 0;
            padding-left: 20px;
        }

        .info-box li {
            margin-bottom: 5px;
        }

    </style>
</head>
<body>
    <!-- ... (giữ nguyên HTML cũ) ... -->

    <div class="container">
        <div class="sidebar">
            <!-- ... (giữ nguyên các section cũ) ... -->

            <div class="section">
                <h3 class="section-title" title="Tự động tạo bản đồ độ lồi lõm">
                    <i class="fas fa-robot"></i> 2. Displacement Map (TỰ ĐỘNG)
                </h3>
                <button class="upload-btn secondary" id="autoCreateDispBtn">
                    <i class="fas fa-magic"></i> Tự động tạo từ Mockup
                </button>
                <button class="upload-btn secondary" id="photopeaBtn">
                    <i class="fas fa-external-link-alt"></i> Mở Photopea Online
                </button>
                <button class="upload-btn secondary" id="uploadDisplacementBtn">
                    <i class="fas fa-grip-lines"></i> Upload có sẵn
                </button>
                <input type="file" id="displacementFile" accept="image/*" hidden>
                
                <div class="info-box" style="margin-top: 10px; padding: 10px; font-size: 0.8em;">
                    <p><strong>Displacement Map là gì?</strong></p>
                    <p>• Ảnh đen trắng tạo hiệu ứng 3D</p>
                    <p>• Trắng = Lồi lên, Đen = Lõm xuống</p>
                    <p>• Dùng nút <i class="fas fa-magic"></i> để tự động tạo</p>
                </div>
            </div>

            <!-- ... (giữ nguyên các section còn lại) ... -->
        </div>

        <!-- ... (giữ nguyên canvas area) ... -->
    </div>

    <!-- MODAL TẠO DISPLACEMENT MAP TỰ ĐỘNG -->
    <div class="overlay" id="dispCreationOverlay"></div>
    <div class="disp-creation-modal" id="dispCreationModal">
        <div class="modal-header">
            <h3 class="save-header">
                <i class="fas fa-robot"></i> Tạo Displacement Map Tự Động
            </h3>
            <button class="close-modal-btn" id="closeDispModal" title="Đóng">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <div class="tab-buttons">
            <button class="tab-btn active" data-tab="auto">Tự Động</button>
            <button class="tab-btn" data-tab="photopea">Photopea Online</button>
            <button class="tab-btn" data-tab="manual">Hướng Dẫn Thủ Công</button>
        </div>

        <!-- TAB 1: TỰ ĐỘNG -->
        <div class="tab-content active" id="tab-auto">
            <div class="disp-preview-container">
                <div class="disp-preview-box">
                    <h4>Mockup Gốc</h4>
                    <canvas id="originalPreview" class="disp-canvas"></canvas>
                </div>
                <div class="disp-preview-box">
                    <h4>Displacement Map (Kết quả)</h4>
                    <canvas id="dispPreview" class="disp-canvas"></canvas>
                </div>
            </div>

            <div class="disp-controls">
                <div class="disp-slider-group">
                    <div class="disp-slider-label">
                        <span>Độ tương phản</span>
                        <span class="disp-slider-value" id="contrastValue">50</span>
                    </div>
                    <input type="range" min="0" max="100" value="50" class="warp-slider" id="contrastSlider">
                </div>

                <div class="disp-slider-group">
                    <div class="disp-slider-label">
                        <span>Độ sáng</span>
                        <span class="disp-slider-value" id="brightnessValue">50</span>
                    </div>
                    <input type="range" min="0" max="100" value="50" class="warp-slider" id="brightnessSlider">
                </div>

                <div class="disp-slider-group">
                    <div class="disp-slider-label">
                        <span>Độ mờ (Blur)</span>
                        <span class="disp-slider-value" id="blurValue">3</span>
                    </div>
                    <input type="range" min="0" max="20" value="3" class="warp-slider" id="blurSlider">
                </div>

                <div class="disp-slider-group">
                    <div class="disp-slider-label">
                        <span>Ngưỡng đen/trắng</span>
                        <span class="disp-slider-value" id="thresholdValue">128</span>
                    </div>
                    <input type="range" min="0" max="255" value="128" class="warp-slider" id="thresholdSlider">
                </div>
            </div>

            <div class="disp-preset-buttons">
                <button class="disp-preset-btn active" data-preset="basic">Cơ bản</button>
                <button class="disp-preset-btn" data-preset="strong">Mạnh</button>
                <button class="disp-preset-btn" data-preset="soft">Mềm mại</button>
                <button class="disp-preset-btn" data-preset="edges">Chi tiết cạnh</button>
                <button class="disp-preset-btn" data-preset="gradient">Gradient</button>
                <button class="disp-preset-btn" data-preset="emboss">Nổi khối</button>
                <button class="disp-preset-btn" data-preset="invert">Đảo ngược</button>
                <button class="disp-preset-btn" data-preset="reset">Reset</button>
            </div>

            <div class="info-box">
                <h4><i class="fas fa-lightbulb"></i> Mẹo sử dụng:</h4>
                <ul>
                    <li><strong>Mockup có nếp gấp</strong>: Dùng preset "Chi tiết cạnh"</li>
                    <li><strong>Mockup cong mềm mại</strong>: Dùng preset "Mềm mại" + tăng Blur</li>
                    <li><strong>Mockup có chữ nổi</strong>: Dùng preset "Nổi khối"</li>
                    <li><strong>Vải/Áo thun</strong>: Tăng độ mờ để tạo cảm giác mềm</li>
                </ul>
            </div>

            <div class="modal-buttons">
                <button class="modal-btn secondary" id="cancelDisp">
                    <i class="fas fa-times"></i> Hủy
                </button>
                <button class="modal-btn primary" id="applyDisp">
                    <i class="fas fa-check"></i> Áp Dụng Map Này
                </button>
            </div>
        </div>

        <!-- TAB 2: PHOTOPEA ONLINE -->
        <div class="tab-content" id="tab-photopea">
            <div class="info-box">
                <h4><i class="fas fa-external-link-alt"></i> Photopea - Photoshop Online Miễn Phí</h4>
                <p>Photopea là phiên bản Photoshop chạy trên trình duyệt, hoàn toàn miễn phí!</p>
                <p><strong>Các bước tạo Displacement Map:</strong></p>
                <ol>
                    <li>Mockup sẽ tự động được tải lên Photopea</li>
                    <li>Nhấn <strong>Ctrl+Shift+U</strong> để chuyển thành ảnh đen trắng</li>
                    <li>Nhấn <strong>Ctrl+L</strong> để mở Levels, kéo thanh trượt để tăng độ tương phản</li>
                    <li>Vào <strong>Filter → Blur → Gaussian Blur</strong> (2-5px)</li>
                    <li>File → Export as → PNG → Tải về</li>
                    <li>Quay lại app và Upload file vừa tải</li>
                </ol>
            </div>

            <div class="photopea-container">
                <iframe id="photopeaFrame" src="https://www.photopea.com" 
                        title="Photopea Online Editor" 
                        allow="fullscreen">
                </iframe>
            </div>

            <div class="modal-buttons">
                <button class="modal-btn secondary" id="closePhotopea">
                    <i class="fas fa-times"></i> Đóng
                </button>
                <button class="modal-btn primary" id="loadFromPhotopea" disabled>
                    <i class="fas fa-download"></i> Tải từ Photopea (Beta)
                </button>
            </div>
        </div>

        <!-- TAB 3: HƯỚNG DẪN THỦ CÔNG -->
        <div class="tab-content" id="tab-manual">
            <div class="info-box">
                <h4><i class="fas fa-graduation-cap"></i> Tạo Displacement Map thủ công</h4>
                
                <h5>Option 1: Dùng Microsoft Paint (có sẵn trên Windows)</h5>
                <ol>
                    <li>Mở mockup trong Paint</li>
                    <li>Vào <strong>File → Save as → PNG</strong></li>
                    <li>Chọn <strong>Monochromatic bitmap</strong> khi save</li>
                    <li>Upload file vừa save vào app</li>
                </ol>

                <h5>Option 2: Dùng website miễn phí</h5>
                <p>Các website chuyển ảnh thành đen trắng:</p>
                <ul>
                    <li><a href="https://pixlr.com/" target="_blank">Pixlr.com</a> (giống Photoshop)</li>
                    <li><a href="https://www.online-image-editor.com/" target="_blank">Online Image Editor</a></li>
                    <li><a href="https://www.photopea.com/" target="_blank">Photopea.com</a> (tốt nhất)</li>
                </ul>

                <h5>Option 3: Dùng điện thoại</h5>
                <p>App miễn phí:</p>
                <ul>
                    <li><strong>Snapseed</strong> (Google): Chuyển đen trắng + chỉnh độ tương phản</li>
                    <li><strong>Adobe Photoshop Express</strong>: Có filter đen trắng chuyên nghiệp</li>
                    <li><strong>PicsArt</strong>: Effect → Black & White</li>
                </ul>
            </div>

            <div class="modal-buttons">
                <button class="modal-btn secondary" id="closeManual">
                    <i class="fas fa-times"></i> Đóng
                </button>
                <button class="modal-btn primary" onclick="window.open('https://www.photopea.com', '_blank')">
                    <i class="fas fa-external-link-alt"></i> Mở Photopea Ngay
                </button>
            </div>
        </div>
    </div>

    <!-- ... (giữ nguyên các modal khác) ... -->

    <script>
        // ========== DISPLACEMENT MAP TỰ ĐỘNG ==========
        const dispCreationModal = document.getElementById('dispCreationModal');
        const dispCreationOverlay = document.getElementById('dispCreationOverlay');
        
        // Biến cho displacement map creation
        let originalImageData = null;
        let currentDispCanvas = null;
        let currentDispContext = null;
        
        // Mở modal tạo displacement map tự động
        document.getElementById('autoCreateDispBtn').addEventListener('click', function() {
            if (!mockupImage) {
                updateStatus('Vui lòng upload mockup trước khi tạo displacement map');
                return;
            }
            
            // Lấy hình ảnh từ mockup
            const mockupElement = mockupImage.getElement();
            if (!mockupElement) {
                updateStatus('Không thể lấy hình ảnh từ mockup');
                return;
            }
            
            // Mở modal
            dispCreationModal.classList.add('active');
            dispCreationOverlay.classList.add('active');
            
            // Chuyển sang tab tự động
            switchTab('auto');
            
            // Khởi tạo preview
            initDispPreview(mockupElement);
            
            updateStatus('Đang mở công cụ tạo displacement map tự động');
        });
        
        // Mở Photopea tab
        document.getElementById('photopeaBtn').addEventListener('click', function() {
            if (!mockupImage) {
                updateStatus('Vui lòng upload mockup trước');
                return;
            }
            
            dispCreationModal.classList.add('active');
            dispCreationOverlay.classList.add('active');
            switchTab('photopea');
            
            // Tải mockup lên Photopea (qua data URL)
            setTimeout(() => {
                loadMockupToPhotopea();
            }, 1000);
        });
        
        // Hàm tải mockup lên Photopea
        function loadMockupToPhotopea() {
            if (!mockupImage) return;
            
            try {
                // Tạo data URL từ mockup
                const tempCanvas = document.createElement('canvas');
                const tempCtx = tempCanvas.getContext('2d');
                
                // Lấy kích thước thực của mockup
                const img = mockupImage.getElement();
                tempCanvas.width = img.naturalWidth || img.width;
                tempCanvas.height = img.naturalHeight || img.height;
                
                // Vẽ ảnh lên canvas
                tempCtx.drawImage(img, 0, 0, tempCanvas.width, tempCanvas.height);
                
                // Chuyển thành data URL
                const dataUrl = tempCanvas.toDataURL('image/png');
                
                // Tạo URL Photopea với hình ảnh
                const photopeaUrl = `https://www.photopea.com#${encodeURIComponent(dataUrl)}`;
                
                // Cập nhật iframe
                const iframe = document.getElementById('photopeaFrame');
                if (iframe) {
                    iframe.src = photopeaUrl;
                }
                
                updateStatus('Đã tải mockup lên Photopea. Chuyển sang tab Photopea để chỉnh sửa.');
            } catch (e) {
                console.error('Lỗi tải lên Photopea:', e);
                updateStatus('Không thể tải lên Photopea. Vui lòng truy cập photopea.com thủ công.');
            }
        }
        
        // Khởi tạo preview displacement map
        function initDispPreview(mockupElement) {
            const originalCanvas = document.getElementById('originalPreview');
            const dispCanvas = document.getElementById('dispPreview');
            
            // Setup canvas
            originalCanvas.width = 400;
            originalCanvas.height = 300;
            dispCanvas.width = 400;
            dispCanvas.height = 300;
            
            const originalCtx = originalCanvas.getContext('2d');
            currentDispContext = dispCanvas.getContext('2d');
            currentDispCanvas = dispCanvas;
            
            // Vẽ ảnh gốc lên canvas
            originalCtx.drawImage(mockupElement, 0, 0, originalCanvas.width, originalCanvas.height);
            
            // Lấy image data
            originalImageData = originalCtx.getImageData(0, 0, originalCanvas.width, originalCanvas.height);
            
            // Tạo displacement map mặc định
            applyDispPreset('basic');
        }
        
        // Hàm tạo displacement map
        function generateDisplacementMap() {
            if (!originalImageData || !currentDispContext) return;
            
            const width = originalImageData.width;
            const height = originalImageData.height;
            const dispData = currentDispContext.createImageData(width, height);
            
            const contrast = parseInt(document.getElementById('contrastSlider').value) / 50;
            const brightness = (parseInt(document.getElementById('brightnessSlider').value) - 50) * 2;
            const blur = parseInt(document.getElementById('blurSlider').value);
            const threshold = parseInt(document.getElementById('thresholdSlider').value);
            
            // Tạo displacement map từ ảnh gốc
            for (let i = 0; i < originalImageData.data.length; i += 4) {
                // Tính độ sáng từ RGB (công thức luminance)
                const r = originalImageData.data[i];
                const g = originalImageData.data[i + 1];
                const b = originalImageData.data[i + 2];
                
                // Tính luminance (độ sáng)
                let luminance = 0.299 * r + 0.587 * g + 0.114 * b;
                
                // Áp dụng contrast và brightness
                luminance = ((luminance - 128) * contrast) + 128 + brightness;
                
                // Áp dụng threshold
                if (threshold !== 128) {
                    luminance = luminance > threshold ? 255 : 0;
                }
                
                // Giới hạn giá trị 0-255
                luminance = Math.max(0, Math.min(255, luminance));
                
                // Gán giá trị cho displacement map (grayscale)
                dispData.data[i] = luminance;     // R
                dispData.data[i + 1] = luminance; // G
                dispData.data[i + 2] = luminance; // B
                dispData.data[i + 3] = 255;       // Alpha
            }
            
            // Áp dụng blur nếu có
            if (blur > 0) {
                applyBlurToImageData(dispData, blur);
            }
            
            // Vẽ lên canvas
            currentDispContext.putImageData(dispData, 0, 0);
        }
        
        // Hàm áp dụng blur
        function applyBlurToImageData(imageData, radius) {
            const width = imageData.width;
            const height = imageData.height;
            const data = imageData.data;
            const newData = new Uint8ClampedArray(data);
            
            // Simple box blur
            for (let y = 0; y < height; y++) {
                for (let x = 0; x < width; x++) {
                    let total = 0;
                    let count = 0;
                    
                    for (let dy = -radius; dy <= radius; dy++) {
                        for (let dx = -radius; dx <= radius; dx++) {
                            const nx = x + dx;
                            const ny = y + dy;
                            
                            if (nx >= 0 && nx < width && ny >= 0 && ny < height) {
                                const idx = (ny * width + nx) * 4;
                                total += data[idx]; // Lấy kênh R (vì grayscale nên R=G=B)
                                count++;
                            }
                        }
                    }
                    
                    const idx = (y * width + x) * 4;
                    const avg = Math.round(total / count);
                    newData[idx] = avg;     // R
                    newData[idx + 1] = avg; // G
                    newData[idx + 2] = avg; // B
                }
            }
            
            // Copy lại vào imageData
            for (let i = 0; i < data.length; i++) {
                data[i] = newData[i];
            }
        }
        
        // Sự kiện cho slider
        const dispSliders = ['contrastSlider', 'brightnessSlider', 'blurSlider', 'thresholdSlider'];
        const dispValues = ['contrastValue', 'brightnessValue', 'blurValue', 'thresholdValue'];
        
        dispSliders.forEach((sliderId, index) => {
            const slider = document.getElementById(sliderId);
            const valueDisplay = document.getElementById(dispValues[index]);
            
            slider.addEventListener('input', function() {
                valueDisplay.textContent = this.value;
                generateDisplacementMap();
            });
        });
        
        // Presets cho displacement map
        document.querySelectorAll('.disp-preset-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                // Xóa active của tất cả các nút
                document.querySelectorAll('.disp-preset-btn').forEach(b => {
                    b.classList.remove('active');
                });
                
                // Thêm active cho nút được nhấn
                this.classList.add('active');
                
                const preset = this.dataset.preset;
                applyDispPreset(preset);
            });
        });
        
        function applyDispPreset(preset) {
            switch(preset) {
                case 'basic':
                    setDispSettings(50, 50, 3, 128);
                    break;
                case 'strong':
                    setDispSettings(80, 40, 1, 150);
                    break;
                case 'soft':
                    setDispSettings(30, 60, 8, 100);
                    break;
                case 'edges':
                    setDispSettings(90, 30, 0, 200);
                    break;
                case 'gradient':
                    setDispSettings(40, 70, 15, 128);
                    break;
                case 'emboss':
                    setDispSettings(70, 30, 2, 180);
                    break;
                case 'invert':
                    setDispSettings(50, 50, 3, 128);
                    // Thêm hiệu ứng đảo ngược sau
                    setTimeout(() => applyInvertEffect(), 10);
                    break;
                case 'reset':
                    setDispSettings(50, 50, 3, 128);
                    break;
            }
        }
        
        function setDispSettings(contrast, brightness, blur, threshold) {
            document.getElementById('contrastSlider').value = contrast;
            document.getElementById('brightnessSlider').value = brightness;
            document.getElementById('blurSlider').value = blur;
            document.getElementById('thresholdSlider').value = threshold;
            
            document.getElementById('contrastValue').textContent = contrast;
            document.getElementById('brightnessValue').textContent = brightness;
            document.getElementById('blurValue').textContent = blur;
            document.getElementById('thresholdValue').textContent = threshold;
            
            generateDisplacementMap();
        }
        
        function applyInvertEffect() {
            if (!currentDispContext) return;
            
            const canvas = currentDispCanvas;
            const ctx = currentDispContext;
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            // Đảo ngược màu sắc
            for (let i = 0; i < data.length; i += 4) {
                data[i] = 255 - data[i];     // R
                data[i + 1] = 255 - data[i + 1]; // G
                data[i + 2] = 255 - data[i + 2]; // B
            }
            
            ctx.putImageData(imageData, 0, 0);
        }
        
        // Áp dụng displacement map đã tạo
        document.getElementById('applyDisp').addEventListener('click', function() {
            if (!currentDispCanvas) {
                updateStatus('Chưa có displacement map để áp dụng');
                return;
            }
            
            // Chuyển canvas thành data URL
            const dataUrl = currentDispCanvas.toDataURL('image/png');
            
            // Tạo đối tượng Image từ data URL
            const img = new Image();
            img.onload = function() {
                displacementMap = img;
                updateStatus('Đã tạo và áp dụng displacement map tự động!');
                closeDispModal();
                
                // Thông báo có thể dùng warp ngay
                setTimeout(() => {
                    updateStatus('Displacement Map đã sẵn sàng. Chọn vật liệu và nhấn "Warp Bề Mặt" để thấy hiệu ứng 3D!');
                }, 500);
            };
            img.src = dataUrl;
        });
        
        // Chuyển tab
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const tabId = this.dataset.tab;
                switchTab(tabId);
                
                // Nếu chuyển sang tab photopea, tải mockup lên
                if (tabId === 'photopea' && mockupImage) {
                    setTimeout(() => {
                        loadMockupToPhotopea();
                    }, 500);
                }
            });
        });
        
        function switchTab(tabId) {
            // Xóa active của tất cả tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Xóa active của tất cả tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Thêm active cho tab được chọn
            document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');
            document.getElementById(`tab-${tabId}`).classList.add('active');
        }
        
        // Đóng modal
        document.getElementById('closeDispModal').addEventListener('click', closeDispModal);
        document.getElementById('cancelDisp').addEventListener('click', closeDispModal);
        document.getElementById('closePhotopea').addEventListener('click', closeDispModal);
        document.getElementById('closeManual').addEventListener('click', closeDispModal);
        dispCreationOverlay.addEventListener('click', closeDispModal);
        
        function closeDispModal() {
            dispCreationModal.classList.remove('active');
            dispCreationOverlay.classList.remove('active');
        }
        
        // ========== CÁC CHỨC NĂNG CŨ (giữ nguyên) ==========
        // ... (giữ nguyên tất cả code cũ từ đây trở xuống) ...
        // Bao gồm: canvas khởi tạo, upload functions, warp functions, v.v.
        
        // Chỉ cần đảm bảo rằng các biến và hàm cần thiết được khai báo
        // Nếu bạn muốn tôi thêm toàn bộ code cũ vào đây, tôi có thể làm
        // Nhưng để tránh làm file quá dài, tôi giả định bạn đã có phần code còn lại
        
    </script>
</body>
</html>
